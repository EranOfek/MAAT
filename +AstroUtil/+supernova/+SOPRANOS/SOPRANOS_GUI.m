function varargout = SOPRANOS_GUI(varargin)
% SOPRANOS_GUI MATLAB code for SOPRANOS_GUI.fig
%      SOPRANOS_GUI, by itself, creates a new SOPRANOS_GUI or raises the existing
%      singleton*.
%
%      H = SOPRANOS_GUI returns the handle to a new SOPRANOS_GUI or the handle to
%      the existing singleton*.
%
%      SOPRANOS_GUI('CALLBACK',hObject,eventData,handles,...) calls the local
%      function named CALLBACK in SOPRANOS_GUI.M with the given input arguments.
%
%      SOPRANOS_GUI('Property','Value',...) creates a new SOPRANOS_GUI or raises the
%      existing singleton*.  Starting from the left, property value pairs are
%      applied to the GUI before SOPRANOS_GUI_OpeningFcn gets called.  An
%      unrecognized property name or invalid value makes property application
%      stop.  All inputs are passed to SOPRANOS_GUI_OpeningFcn via varargin.
%
%      *See GUI Options on GUIDE's Tools menu.  Choose "GUI allows only one
%      instance to run (singleton)".
%
% See also: GUIDE, GUIDATA, GUIHANDLES

% Edit the above text to modify the response to help SOPRANOS_GUI

% Last Modified by GUIDE v2.5 21-Oct-2019 14:38:24

% Begin initialization code - DO NOT EDIT
gui_Singleton = 1;
%gui_State = struct('gui_Name',       mfilename, ...
gui_State = struct('gui_Name',       mfilename('fullpath'), ...
                   'gui_Singleton',  gui_Singleton, ...
                   'gui_OpeningFcn', @SOPRANOS_GUI_OpeningFcn, ...
                   'gui_OutputFcn',  @SOPRANOS_GUI_OutputFcn, ...
                   'gui_LayoutFcn',  @SOPRANOS_GUI_LayoutFcn, ...
                   'gui_Callback',   []);
if nargin && ischar(varargin{1})
    gui_State.gui_Callback = str2func(varargin{1});
end

if nargout
    [varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
else
    gui_mainfcn(gui_State, varargin{:});
end
% End initialization code - DO NOT EDIT


% --- Executes just before SOPRANOS_GUI is made visible.
function SOPRANOS_GUI_OpeningFcn(hObject, eventdata, handles, varargin)
% This function has no output args, see OutputFcn.
% hObject    handle to figure
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
% varargin   command line arguments to SOPRANOS_GUI (see VARARGIN)

% Choose default command line output for SOPRANOS_GUI
handles.output = hObject;

% Update handles structure
guidata(hObject, handles);

% UIWAIT makes SOPRANOS_GUI wait for user response (see UIRESUME)
% uiwait(handles.SOPRANOS_GUI);


% --- Outputs from this function are returned to the command line.
function varargout = SOPRANOS_GUI_OutputFcn(hObject, eventdata, handles) 
% varargout  cell array for returning output args (see VARARGOUT);
% hObject    handle to figure
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Get default command line output from handles structure
varargout{1} = handles.output;
pause(0.001);
GraphsNumber_SelectionChangedFcn(handles.ThreeGraphs, eventdata, handles);



% --- Executes on selection change in BandNumber.
function BandNumber_Callback(hObject, eventdata, handles)
% hObject    handle to BandNumber (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: contents = cellstr(get(hObject,'String')) returns BandNumber contents as cell array
%        contents{get(hObject,'Value')} returns selected item from BandNumber
if ~isempty(handles.Table.UserData.Selected)
    delete(handles.Table.UserData.Selected)
    handles.Table.UserData.Selected=[];
end
Table_Update(hObject.Value,handles);
handles.PlottedInGraph.Value = handles.PlottedInGraph.UserData(hObject.Value);
handles.Background.Value = handles.Background.UserData(hObject.Value);
BackgroundValue_UpdateTxt(handles.BackgroundValue, eventdata, handles);
if isempty(handles.BandName.UserData{hObject.Value})
    handles.BandName.String = sprintf('%s %s',handles.SOPRANOS.UserData.data.bands{hObject.Value}.instrumentname,...
        handles.SOPRANOS.UserData.data.bands{hObject.Value}.filtername);
else
    handles.BandName.String = handles.BandName.UserData{hObject.Value};
end

% --- Executes during object creation, after setting all properties.
function BandNumber_CreateFcn(hObject, eventdata, handles)
% hObject    handle to BandNumber (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: popupmenu controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


% --- Executes on selection change in PlottedInGraph.
function PlottedInGraph_Callback(hObject, eventdata, handles)
% hObject    handle to PlottedInGraph (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: contents = cellstr(get(hObject,'String')) returns PlottedInGraph contents as cell array
%        contents{get(hObject,'Value')} returns selected item from PlottedInGraph
iband = handles.BandNumber.Value;
hObject.UserData(iband)=hObject.Value;
Graphs_PlotPoints(handles);


% --- Executes during object creation, after setting all properties.
function PlottedInGraph_CreateFcn(hObject, eventdata, handles)
% hObject    handle to PlottedInGraph (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: popupmenu controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


% --- Executes on button press in Outlier.
function Outlier_Callback(hObject, eventdata, handles)
% hObject    handle to Outlier (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --- Executes on button press in Load.
function Load_Callback(hObject, eventdata, handles, filename)
% hObject    handle to Load (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if (nargin==3)
    [filename, pathname]=uigetfile('*_data.mat','Load data file');
    if (filename == 0)
        return
    end
else
    pathname = '.';
end

data=load(fullfile(pathname,filename));

nBands = length(data.bands);
bandsStr = cell(nBands,1);
handles.BandName.UserData = cell(nBands,1);
for iBand=1:nBands
    bandsStr{iBand} = sprintf('%d - %s %s',iBand,data.bands{iBand}.instrumentname,data.bands{iBand}.filtername);
    handles.BandName.UserData{iBand} = sprintf('%s %s',data.bands{iBand}.instrumentname,data.bands{iBand}.filtername);
end
handles.BandNumber.String = bandsStr;
handles.BandNumber.Enable  = 'on';
handles.BandNumber.Value = 1;

handles.BandName.String = handles.BandName.UserData{1};
handles.MinTPoints.UserData=zeros(nBands,1);
handles.MinTPoints.String = '0';
MinTPointsBand_UpdateText(handles.MinTPointsBand, eventdata, handles);

handles.PlottedInGraph.UserData = ones(nBands,1);
handles.PlottedInGraph.Enable = 'on';
handles.Background.UserData = ones(nBands,1);
handles.Background.Enable = 'on';
for iband = 1:length(data.bands)
    data.bands{iband}.background = 0;
    data.bands{iband}.bg = [];
end

handles.SOPRANOS.UserData.data = data;
handles.SOPRANOS.UserData.file.filename = filename;
handles.SOPRANOS.UserData.file.pathname = pathname;

handles.SNname.String = data.snname;
handles.RedShift.String = data.redshift;
handles.RA.String = data.RAh;
handles.dec.String = data.decd;

Table_Update(1, handles);
Graphs_PlotPoints(handles);
handles.Transient.Enable = 'on';

% --- Executes on button press in NewDataFile.
function NewDataFile_Callback(hObject, eventdata, handles)
% hObject    handle to NewDataFile (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
[filename pathname]=uigetfile({'*.txt;*.csv;*.out_PTF48R'},'Load raw data file');
if (filename == 0)
    return
end

if ~strcmp(pathname,pwd)&&~contains(path,pathname)
    addpath(pathname);
    pathadd = true;
else
    pathadd = false;
end
[~,snname,ext] = fileparts(filename);
if strcmpi(snname(1:3),'ztf')
    answer=inputdlg({'Redshift','RA','dec'},'Additional SN parameters',[1 35], {'0','0','0'});
    AstroUtil.supernova.SOPRANOS.prepareSNdata(snname,str2num(answer{1}),answer{2},answer{3});
elseif strcmpi(snname(1:3),'ptf')
    AstroUtil.supernova.SOPRANOS.prepareSNdata(snname);
end
datafilename = [snname '_data.mat'];
handles.Plot.UserData = [];
Load_Callback(handles.Load, eventdata, handles, datafilename)

if pathadd
    rmpath(pathname)
end

handles.TransientStart.Enable = 'off';
handles.TransientEnd.Enable = 'off';
    
% --- Executes on button press in Save.
function Save_Callback(hObject, eventdata, handles)
% hObject    handle to Save (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
[filename, pathname]=uiputfile('*_data.mat','Save data file', fullfile(handles.SOPRANOS.UserData.file.pathname,handles.SOPRANOS.UserData.file.filename));
if (filename == 0)
    return
end

data = handles.SOPRANOS.UserData.data;
datafile=matfile(fullfile(pathname,filename),'Writable',true);
datafile.snname   = data.snname;
datafile.RAh      = data.RAh;
datafile.RArad    = data.RArad;
datafile.decd     = data.decd;
datafile.decRad   = data.decRad;
datafile.redshift = data.redshift;
datafile.bands    = data.bands;
if ~isempty(handles.Transient.UserData)
    datafile.TransientStart = str2num(handles.TransientStart.String);
    datafile.TransientEnd   = str2num(handles.TransientEnd.String);
end

% --- Executes on button press in Transient.
function Transient_Callback(hObject, eventdata, handles, xlim)
% hObject    handle to Transient (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if strcmp(handles.TransientStart.Enable,'off')
    handles.TransientStart.Enable = 'on';
    handles.TransientEnd.Enable = 'on';

    if nargin==3
        xlim = handles.Graphs.UserData(1).XLim;
    end
    handles.TransientStart.String = xlim(1);
    handles.TransientEnd.String = xlim(2);
    for igraph = 1:length(handles.Graphs.UserData)
        ax = handles.Graphs.UserData(igraph);
        ylim = ax.YLim;
        ax.XLimMode = 'manual'; ax.YLimMode = 'manual';
        pos = [xlim(1) ylim(1) xlim(2)-xlim(1), ylim(2)-ylim(1)];
              ylim = handles.Graphs.UserData(igraph).YLim;
  
        h=imrect(handles.Graphs.UserData(igraph), pos);
        addNewPositionCallback(h,@(p) updateTransient(p,handles,igraph));
        rects(igraph)=h;
    end
    hObject.UserData = rects;
end

function updateTransient(pos, handles, actor)
    handles.TransientStart.String = pos(1);
    handles.TransientEnd.String = pos(1)+pos(3);
    for igraph=1:length(handles.Transient.UserData)
            ylim = handles.Graphs.UserData(igraph).YLim;
            ipos(1)=pos(1); ipos(2)=ylim(1); ipos(3)=pos(3); ipos(4)=ylim(2)-ylim(1);
            handles.Transient.UserData(igraph).setPosition(ipos);
    end


function TransientStart_Callback(hObject, eventdata, handles)
% hObject    handle to TransientStart (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of TransientStart as text
%        str2double(get(hObject,'String')) returns contents of TransientStart as a double
TStart = str2num(hObject.String);
TEnd = str2num(handles.TransientEnd.String);
updateTransient([TStart 0 TEnd-TStart 0], handles, 0)

% --- Executes during object creation, after setting all properties.
function TransientStart_CreateFcn(hObject, eventdata, handles)
% hObject    handle to TransientStart (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function TransientEnd_Callback(hObject, eventdata, handles)
% hObject    handle to TransientEnd (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of TransientEnd as text
%        str2double(get(hObject,'String')) returns contents of TransientEnd as a double
TStart = str2num(handles.TransientStart.String);
TEnd = str2num(hObject.String);
updateTransient([TStart 0 TEnd-TStart 0], handles, 0)


% --- Executes during object creation, after setting all properties.
function TransientEnd_CreateFcn(hObject, eventdata, handles)
% hObject    handle to TransientEnd (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


% --- Executes on button press in SaveSettings.
function SaveSettings_Callback(hObject, eventdata, handles)
% hObject    handle to SaveSettings (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
filename = [handles.SOPRANOS.UserData.file.filename(1:end-8) 'GUI.mat'];
ngraphs = str2num(handles.GraphsNumber.SelectedObject.String);
bandGraph = handles.PlottedInGraph.UserData;
Background = handles.Background.UserData;
legendPos = cell(ngraphs,1);
for igraph = 1:ngraphs
    legendPos{igraph} = handles.Graphs.UserData(igraph).Legend.Position;
    zoom.ylim(igraph,:) = handles.Graphs.UserData(igraph).YLim;    
end
zoom.xlim = handles.Graphs.UserData(ngraphs).XLim;

data = handles.SOPRANOS.UserData.data;
datafile = handles.SOPRANOS.UserData.file;
bandNames = handles.BandName.UserData;

if ~isempty(handles.Transient.UserData)
    TransientStart = str2num(handles.TransientStart.String);
    TransientEnd   = str2num(handles.TransientEnd.String);
else
    TransientStart = [];
    TransientEnd   = [];
end

if ~isempty(handles.Plot.UserData)
    PlotParams = handles.Plot.UserData.params;
else
    PlotParams = [];
end
gridVecs = handles.Grid.UserData;
save(fullfile(handles.SOPRANOS.UserData.file.pathname,filename), 'data', 'datafile', 'ngraphs', 'bandGraph', 'legendPos', ...
    'TransientStart', 'TransientEnd', 'PlotParams', 'Background','gridVecs', 'zoom', 'bandNames');

% --- Executes on button press in LoadSettings.
function LoadSettings_Callback(hObject, eventdata, handles)
% hObject    handle to LoadSettings (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
[filename pathname]=uigetfile('*_GUI.mat','Load GUI file');
if (filename == 0)
    return
end
settings=load(fullfile(pathname,filename));
numbers={'OneGraph','TwoGraphs','ThreeGraphs'};

handles.SOPRANOS.UserData.data = settings.data;
handles.SOPRANOS.UserData.file = settings.datafile;
handles.SOPRANOS.UserData.file.pathname = pathname;

handles.GraphsNumber.SelectedObject = eval(strcat('handles.',numbers{settings.ngraphs}));
GraphsNumber_SelectionChangedFcn(handles.GraphsNumber.SelectedObject, eventdata, handles);
handles.PlottedInGraph.UserData = settings.bandGraph;
handles.Background.UserData = settings.Background;
handles.Background.Value = settings.Background(1);
handles.Background.Enable  = 'on';
BackgroundValue_UpdateTxt(handles.BackgroundValue, eventdata, handles);

handles.SNname.String = settings.data.snname;
handles.RedShift.String = settings.data.redshift;
handles.RA.String = settings.data.RAh;
handles.dec.String = settings.data.decd;
handles.MWEbv.String = sprintf('MW Ebv %6.4f',AstroUtil.spec.sky_ebv(settings.data.RArad,settings.data.decRad));
Table_Update(1,handles);

nBands = length(settings.data.bands);
if isfield(settings,'bandNames')
    handles.BandName.UserData = settings.bandNames;
else
    handles.BandName.UserData = cell(nBands,1);
end
bandsStr = cell(nBands,1);
for iBand=1:nBands
    if isempty(handles.BandName.UserData{iBand})
        bandsStr{iBand} = sprintf('%d - %s %s',iBand,settings.data.bands{iBand}.instrumentname,settings.data.bands{iBand}.filtername);
    else
        bandsStr{iBand} = sprintf('%d - %s', iBand, handles.BandName.UserData{iBand});
    end
end
handles.BandNumber.String = bandsStr;
handles.BandNumber.Enable  = 'on';
handles.BandNumber.Value = 1;
handles.BandName.String = handles.BandName.UserData{1};

handles.MinTPoints.UserData=zeros(nBands,1);
handles.MinTPoints.String = '0';
MinTPointsBand_UpdateText(handles.MinTPointsBand, eventdata, handles);

handles.PlottedInGraph.Value = handles.PlottedInGraph.UserData(1);
handles.PlottedInGraph.Enable = 'on';

if ~isempty(settings.TransientStart)    
    handles.TransientStart.String = settings.TransientStart;
    handles.TransientEnd.String = settings.TransientEnd;
    handles.TransientStart.Enable = 'on';
end
if ~isempty(settings.PlotParams)
    handles.Plot.UserData.PlotParams = settings.PlotParams;
else
    handles.Plot.UserData = [];
end
Graphs_PlotPoints(handles);
for igraph = 1:settings.ngraphs
    handles.Graphs.UserData(igraph).Legend.Position = settings.legendPos{igraph};
    zoom(handles.Graphs.UserData(igraph),'reset');
    handles.Graphs.UserData(igraph).YLim = settings.zoom.ylim(igraph,:);
end
handles.Graphs.UserData(igraph).XLim = settings.zoom.xlim;

handles.Transient.Enable = 'on';
handles.Grid.UserData = settings.gridVecs;
Grid_UpdateList(handles.Grid, 1, 'load');
Grid_UpdateList(handles.Grid, 2, 'load');
Grid_UpdateList(handles.Grid, 3, 'load');
Grid_UpdateList(handles.Grid, 4, 'load');
Grid_UpdateList(handles.Grid, 5, 'load');
Grid_UpdateList(handles.Grid, 6, 'load');



% --- Executes when selected object is changed in GraphsNumber.
function GraphsNumber_SelectionChangedFcn(hObject, eventdata, handles)
% hObject    handle to the selected object in GraphsNumber 
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
h=handles.Graphs;
if ~isempty(h.UserData)
    for i=1:length(h.UserData)
        delete(h.UserData(i));
    end
end
switch hObject.Tag
    case 'OneGraph'
        h1=axes(h,'Position',[0.1 0.1 0.87 0.87]);
        h1.Toolbar.Visible = 'on';
        handles.PlottedInGraph.String = {'1'};
        xlabel(h1,'MJD [days]','FontSize',14);
        ylabel(h1,'flux [$erg\,s^{-1}\,cm^{-2}\,\AA^{-1}$]','Interpreter','LATEX','FontSize',14);
        h.UserData = h1;
    case 'TwoGraphs'
        h1=axes(h,'Position',[0.1 0.535 0.87 0.435]);
        h2=axes(h,'Position',[0.1 0.1 0.87 0.435]);
        h1.XTickLabel = [];
        linkaxes([h1 h2],'x');
        h1.Toolbar.Visible = 'on';
        h2.Toolbar.Visible = 'on';
        h.UserData = [h1 h2];
        handles.PlottedInGraph.String = {'1','2'};        
        xlabel(h2,'MJD [days]','FontSize',14);
        htxt=ylabel(h2,'flux [$erg\,s^{-1}\,cm^{-2}\,\AA^{-1}$]','Interpreter','LATEX','FontSize',14);
        pos = htxt.Position;
        htxt.Position(2) = 1;
        htxt.Units = 'normal';
    case 'ThreeGraphs'
        h1=axes(h,'Position',[0.1 0.68 0.87 0.29]);
        h2=axes(h,'Position',[0.1 0.39 0.87 0.29]);
        h3=axes(h,'Position',[0.1 0.1 0.87 0.29]);
        h1.XTickLabel = [];
        h2.XTickLabel = [];
        h1.Toolbar.Visible = 'on';
        h2.Toolbar.Visible = 'on';
        h3.Toolbar.Visible = 'on';
        linkaxes([h1 h2 h3],'x');
        h.UserData = [h1 h2 h3];
        handles.PlottedInGraph.String = {'1','2','3'};
        xlabel(h3,'MJD [days]','FontSize',14);
        ylabel(h2,'flux [$erg\,s^{-1}\,cm^{-2}\,\AA^{-1}$]','Interpreter','LATEX','FontSize',14);
end

% --- Executes update table data upon load or change of band number.
function Table_Update(iband, handles)
% iband      the band number to display
% handles    structure with handles and user data (see GUIDATA)
data = handles.SOPRANOS.UserData.data.bands{iband}.LC;
tab = table2cell(data);
colNames = data.Properties.VariableNames;
if any(strcmp(colNames,'outliers'))
    nOutlier = find(strcmp(colNames,'outliers'));
else
    tab(:,end+1)=num2cell(false(size(tab,1),1));
    colNames(end+1)={'outliers'};
    nOutlier=length(colNames);
end
% covert categorical to string
catID = cellfun(@iscategorical,tab(1,:));
tab(:,catID) = cellfun(@cellstr,tab(:,catID));
strID = cellfun(@isstring,tab(1,:));
tab(:,strID) = cellfun(@cellstr,tab(:,strID));
dateID = cellfun(@isdatetime,tab(1,:));
tab(:,dateID) = cellfun(@cellstr,tab(:,dateID));

handles.Table.Data = tab;
handles.Table.ColumnName = colNames;
handles.Table.ColumnEditable = false(size(colNames));
handles.Table.ColumnEditable(nOutlier) = true;
handles.Table.RowName = [];
handles.Table.UserData.OutlierCol = nOutlier;
handles.Table.UserData.Selected = [];
colFormat = cell(size(colNames));
for iCol = 1:length(colFormat)
    switch lower(colNames{iCol})
        case {'jd','mjd'}
            colFormat{iCol} = 'long g';
        case {'mag','magerr','abs','absmagerr'}
            colFormat{iCol} = 'short';
        case {'flux','fluxerr','errm','errp'}
            colFormat{iCol} = 'short g';
        case {'outlier'}
            colFormat{iCol} = 'logical';
    end
end
handles.Table.ColumnFormat=colFormat;

% --- Executes when entered data in editable cell(s) in Table.
function Table_CellEditCallback(hObject, eventdata, handles)
% hObject    handle to Table (see GCBO)
% eventdata  structure with the following fields (see MATLAB.UI.CONTROL.TABLE)
%	Indices: row and column indices of the cell(s) edited
%	PreviousData: previous data for the cell(s) edited
%	EditData: string(s) entered by the user
%	NewData: EditData or its converted form set on the Data property. Empty if Data was not changed
%	Error: error string when failed to convert EditData to appropriate value for Data
% handles    structure with handles and user data (see GUIDATA)
outliers = cell2mat(hObject.Data(:,hObject.UserData.OutlierCol));
iband = handles.BandNumber.Value;
if any(outliers)
    handles.SOPRANOS.UserData.data.bands{iband}.LC.outliers = outliers;
elseif ismember('outliers',handles.SOPRANOS.UserData.data.bands{iband}.LC.Properties.VariableNames)
    handles.SOPRANOS.UserData.data.bands{iband}.LC.outliers = [];
end
Graphs_PlotPoints(handles);


% --- Executes when selected cell(s) is changed in Table.
function Table_CellSelectionCallback(hObject, eventdata, handles)
% hObject    handle to Table (see GCBO)
% eventdata  structure with the following fields (see MATLAB.UI.CONTROL.TABLE)
%	Indices: row and column indices of the cell(s) currently selecteds
% handles    structure with handles and user data (see GUIDATA)
iband = handles.BandNumber.Value;
ax = handles.Graphs.UserData(handles.PlottedInGraph.UserData(iband));
rows = eventdata.Indices(:,1);

data = handles.SOPRANOS.UserData.data.bands{iband}.LC;
if ~isempty(hObject.UserData.Selected)
    delete(hObject.UserData.Selected);
end
hObject.UserData.Selected=plot(ax,data{rows,'MJD'},data{rows,'flux'},'ok','MarkerSize',13,'LineWidth',2,'DisplayName','Table Highlight');


% --- Executes when entered data in editable cell(s) in Table.
function Graphs_PlotPoints(handles)
% handles    structure with handles and user data (see GUIDATA)
graphID = handles.PlottedInGraph.UserData;
ngraphs = str2num(handles.GraphsNumber.SelectedObject.String);
for igraph = 1:ngraphs
    cla(handles.Graphs.UserData(igraph));
    hold(handles.Graphs.UserData(igraph),'on');
    handles.Graphs.UserData(igraph).XLimMode='auto';
    handles.Graphs.UserData(igraph).YLimMode='auto';
end
leg = cell(ngraphs,1);
% plot data
xlimits = [];
for iband=1:length(graphID)
    data = handles.SOPRANOS.UserData.data.bands{iband};
    if any(ismember(data.LC.Properties.VariableNames,'outliers'))
        LC = data.LC(~data.LC.outliers,{'MJD','flux','fluxerr'});
    else
        LC = data.LC;
    end
    hEB=errorbar(handles.Graphs.UserData(graphID(iband)),LC.MJD,LC.flux,LC.fluxerr,'o','MarkerFaceColor','auto');
    bandColor(iband,:)=hEB.Color;
    if isempty(xlimits)
        xlimits=handles.Graphs.UserData(graphID(iband)).XLim;
    else
        XLim = handles.Graphs.UserData(graphID(iband)).XLim;
        xlimits(1) = min(xlimits(1),XLim(1));
        xlimits(2) = max(xlimits(2),XLim(2));
    end       
    
    if isempty(handles.BandName.UserData{iband})
        legtxt = sprintf('%s %s',data.instrumentname,data.filtername);
    else
        legtxt = sprintf('%s',handles.BandName.UserData{iband});
    end
    if isempty(leg{graphID(iband)})
        leg{graphID(iband)} = {legtxt};
    else
        leg{graphID(iband)}(end+1) = {legtxt};
    end
end
% plot limits
if handles.Limits.Value == 1
    for iband=1:length(graphID)
        data = handles.SOPRANOS.UserData.data.bands{iband};
        if ~isempty(data.limits)
            if any(ismember(data.limits.Properties.VariableNames,'fluxerr'))
                plot(handles.Graphs.UserData(graphID(iband)),data.limits.MJD,data.limits.flux+3*data.limits.fluxerr,'v','Color',bandColor(iband,:));
            else
                plot(handles.Graphs.UserData(graphID(iband)),data.limits.MJD,data.limits.flux,'v','Color',bandColor(iband,:));
            end
            XLim = handles.Graphs.UserData(graphID(iband)).XLim;
            xlimits(1) = min(xlimits(1),XLim(1));
            xlimits(2) = max(xlimits(2),XLim(2));
            if isempty(handles.BandName.UserData{iband})
                leg{graphID(iband)}(end+1) = {sprintf('%s %s limits',data.instrumentname,data.filtername)};
            else
                leg{graphID(iband)}(end+1) = {sprintf('%s limits',handles.BandName.UserData{iband})};
            end
        end
    end
end
%plot outliers
for iband=1:length(graphID)
    data = handles.SOPRANOS.UserData.data.bands{iband};
    if any(ismember(data.LC.Properties.VariableNames,'outliers'))
        LC = data.LC(data.LC.outliers,{'MJD','flux','fluxerr'});
        hEB=errorbar(handles.Graphs.UserData(graphID(iband)),LC.MJD,LC.flux,LC.fluxerr,'o','Color',bandColor(iband,:),'MarkerFaceColor','none');
        if isempty(handles.BandName.UserData{iband})
            leg{graphID(iband)}(end+1) = {sprintf('%s %s outliers',data.instrumentname,data.filtername)};
        else
            leg{graphID(iband)}(end+1) = {sprintf('%s outliers',handles.BandName.UserData{iband})};
        end
    end
end

% add legend
for igraph = 1:ngraphs
    if ~isempty(leg{igraph})
        legend(handles.Graphs.UserData(igraph),leg{igraph},'Interpreter','none');
    end
end
for igraph = 1:ngraphs-1
    handles.Graphs.UserData(igraph).XTickLabel = [];
end
handles.Graphs.UserData(ngraphs).XAxis.Exponent = 0;
% handles.Graphs.UserData(ngraphs).XLim=[-inf inf];
linkaxes(handles.Graphs.UserData,'x');

if (strcmp(handles.TransientStart.Enable,'on'))
    handles.TransientStart.Enable = 'off';
    xlim = [str2num(handles.TransientStart.String) str2num(handles.TransientEnd.String)];
    Transient_Callback(handles.Transient, [], handles, xlim);
end

if ~isempty(handles.Plot.UserData)
     PlotParams = handles.Plot.UserData.PlotParams;
%    PlotParams = handles.Plot.UserData.params;
    switch PlotParams.model
        case 'SW', handles.Model.Value = 1;
        case 'RW', handles.Model.Value = 2;
        case 'MSG', handles.Model.Value = 3;
    end
    switch PlotParams.prog
        case 'RSG', handles.Prog.Value = 1;
        case 'BSG', handles.Prog.Value = 2;
    end
    handles.Rs.String   = PlotParams.Rs;
    handles.Vs.String   = PlotParams.Vs/10^8.5;
    handles.Ms.String   = PlotParams.Ms;
    handles.frho.String = PlotParams.frho;
    handles.t0.String   = PlotParams.t0;
    handles.Ebv.String  = PlotParams.Ebv;
    Plot_Callback(handles.Plot, [], handles);
end
handles.Graphs.UserData(end).XLim = xlimits;


% --- Executes on selection change in Model.
function Model_Callback(hObject, eventdata, handles)
% hObject    handle to Model (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: contents = cellstr(get(hObject,'String')) returns Model contents as cell array
%        contents{get(hObject,'Value')} returns selected item from Model


% --- Executes during object creation, after setting all properties.
function Model_CreateFcn(hObject, eventdata, handles)
% hObject    handle to Model (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: popupmenu controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


% --- Executes on selection change in Prog.
function Prog_Callback(hObject, eventdata, handles)
% hObject    handle to Prog (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: contents = cellstr(get(hObject,'String')) returns Prog contents as cell array
%        contents{get(hObject,'Value')} returns selected item from Prog


% --- Executes during object creation, after setting all properties.
function Prog_CreateFcn(hObject, eventdata, handles)
% hObject    handle to Prog (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: popupmenu controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function Vs_Callback(hObject, eventdata, handles)
% hObject    handle to Vs (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of Vs as text
%        str2double(get(hObject,'String')) returns contents of Vs as a double


% --- Executes during object creation, after setting all properties.
function Vs_CreateFcn(hObject, eventdata, handles)
% hObject    handle to Vs (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function Ms_Callback(hObject, eventdata, handles)
% hObject    handle to Ms (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of Ms as text
%        str2double(get(hObject,'String')) returns contents of Ms as a double


% --- Executes during object creation, after setting all properties.
function Ms_CreateFcn(hObject, eventdata, handles)
% hObject    handle to Ms (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function frho_Callback(hObject, eventdata, handles)
% hObject    handle to frho (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of frho as text
%        str2double(get(hObject,'String')) returns contents of frho as a double


% --- Executes during object creation, after setting all properties.
function frho_CreateFcn(hObject, eventdata, handles)
% hObject    handle to frho (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function t0_Callback(hObject, eventdata, handles)
% hObject    handle to t0 (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of t0 as text
%        str2double(get(hObject,'String')) returns contents of t0 as a double


% --- Executes during object creation, after setting all properties.
function t0_CreateFcn(hObject, eventdata, handles)
% hObject    handle to t0 (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function Ebv_Callback(hObject, eventdata, handles)
% hObject    handle to Ebv (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of Ebv as text
%        str2double(get(hObject,'String')) returns contents of Ebv as a double


% --- Executes during object creation, after setting all properties.
function Ebv_CreateFcn(hObject, eventdata, handles)
% hObject    handle to Ebv (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white back,ground on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


% --- Executes on button press in Plot.
function Plot_Callback(hObject, eventdata, handles)
% hObject    handle to Plot (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
model =  cell2mat(handles.Model.String(handles.Model.Value));
prog  =  cell2mat(handles.Prog.String(handles.Prog.Value));
Rs    =  str2num(handles.Rs.String);
Vs    =  str2num(handles.Vs.String)*10^8.5;
Ms    =  str2num(handles.Ms.String);
frho  =  str2num(handles.frho.String);
t0    =  str2num(handles.t0.String);
Ebv   =  str2num(handles.Ebv.String);
z     =  handles.SOPRANOS.UserData.data.redshift;

[~,~,~,~,~,t_min,t_max,t_opac,~,t_delta] = AstroUtil.supernova.sn_cooling_sw(1,'Model',model,'Type',prog,'Rs',Rs,'Vs',Vs,'Ms',Ms,'f_rho',frho);
switch model
    case 'SW'
        time = linspace(t_min,min(t_max,t_opac),250)*(1+z);
    case 'RW'
        time = linspace(t_min,min(t_delta,t_opac),250)*(1+z);
    case 'MSW'
        [~,~,~,~,~,t_min,t_max] = AstroUtil.supernova.sn_cooling_msw(1,'Model',model,'Type',prog,'Rs',Rs,'Vs',Vs,'Ms',Ms,'f_rho',frho);
        time = linspace(t_min,t_max,250)*(1+z);        
end

for iband = 1:length(handles.PlottedInGraph.UserData)
    if handles.Background.UserData(iband) ~= 1
        bg(iband) = handles.SOPRANOS.UserData.data.bands{iband}.background;
    else
        bg(iband) = 0;
    end
    ax = handles.Graphs.UserData(handles.PlottedInGraph.UserData(iband));
    switch model
        case {'SW','RW'}
            [~,~,~,~,Mag] = AstroUtil.supernova.sn_cooling_sw(time,'Model',model,'Type',prog,'Rs',Rs,'Vs',Vs,'Ms',Ms,'f_rho',frho, ...
                            'redshift',z,'Ebv',Ebv,'FiltFam',handles.SOPRANOS.UserData.data.bands{iband}.filterObj);
        case 'MSW'
            [~,~,~,~,Mag] = AstroUtil.supernova.sn_cooling_msw(time,'Model',model,'Type',prog,'Rs',Rs,'Vs',Vs,'Ms',Ms,'f_rho',frho, ...
                            'redshift',z,'Ebv',Ebv,'FiltFam',handles.SOPRANOS.UserData.data.bands{iband}.filterObj);
    end
    f = convert.flux(Mag,'ab','cgs/A',handles.SOPRANOS.UserData.data.bands{iband}.filterObj.pivot_wl_photon,'A');
    if isempty(handles.BandName.UserData{iband})
        name = sprintf('%s %s',handles.SOPRANOS.UserData.data.bands{iband}.instrumentname,handles.SOPRANOS.UserData.data.bands{iband}.filtername);
    else
        name = handles.BandName.UserData{iband};
    end
    for iChild = 1:length(ax.Children)
        if strcmpi(ax.Children(iChild).DisplayName,name)
            Color(iband,:) = ax.Children(iChild).Color;
        end
    end
    hObject.UserData.plots(iband)=plot(ax,t0+time,f+bg(iband),'-','Color',Color(iband,:),'DisplayName',[name ' ' model ' model']);
end

for iband = 1:length(handles.PlottedInGraph.UserData)
    if handles.Background.UserData(iband) ~= 1
        ax = handles.Graphs.UserData(handles.PlottedInGraph.UserData(iband));
        name = sprintf('%s %s',handles.SOPRANOS.UserData.data.bands{iband}.instrumentname,handles.SOPRANOS.UserData.data.bands{iband}.filtername);
        tlim = ax.XLim;
        hObject.UserData.bg(iband)=plot(ax,tlim,bg(iband)*[1 1],'--','Color',Color(iband,:),'DisplayName',[name ' ' model ' background']);
    end
end


hObject.UserData.params = struct('model',model,...
                                 'prog',prog,...
                                 'Rs',Rs,'Vs',Vs,'Ms',Ms,...
                                 'frho',frho,'t0',t0,'Ebv',Ebv,'redshift',z,'bg',bg,'line','-');


% --- Executes on button press in Clear.
function Clear_Callback(hObject, eventdata, handles)
% hObject    handle to Clear (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if ~isempty(handles.Plot.UserData)
    for iband = 1:length(handles.Plot.UserData.plots)
        delete(handles.Plot.UserData.plots(iband));
%        if exist('handles.Plot.UserData.bg','var')&&~isempty(handles.Plot.UserData.bg(iband))
        if sum(strcmp(fieldnames(handles.Plot.UserData), 'bg'))==1 && ~isempty(handles.Plot.UserData.bg(iband))
            delete(handles.Plot.UserData.bg(iband));
        end
    end
    handles.Plot.UserData = [];
end
   


% --- Executes on button press in Limits.
function Limits_Callback(hObject, eventdata, handles)
% hObject    handle to Limits (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hint: get(hObject,'Value') returns toggle state of Limits
Graphs_PlotPoints(handles)


% --- Executes on selection change in Background.
function Background_Callback(hObject, eventdata, handles)
% hObject    handle to Background (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: contents = cellstr(get(hObject,'String')) returns Background contents as cell array
%        contents{get(hObject,'Value')} returns selected item from Background
iband = (handles.BandNumber.Value);
hObject.UserData(handles.BandNumber.Value) = hObject.Value;
switch hObject.Value
    % zero - the data is already substracted
    case 1
        handles.SOPRANOS.UserData.data.bands{iband}.background = 0;
        handles.SOPRANOS.UserData.data.bands{iband}.bg =[]; 

    % estimate from the data points which are before the transient
    % assuming the data after the transeint already returned to its
    % background level.
    case 2
        tab = handles.SOPRANOS.UserData.data.bands{iband}.LC;
        TransientStart = str2num(handles.TransientStart.String);
        TransientEnd = str2num(handles.TransientEnd.String);
        tab = tab((tab.MJD<TransientStart), {'flux', 'fluxerr'});
        
        bg = sum(tab.flux./tab.fluxerr.^2)./sum(1./tab.fluxerr.^2);
        chi2 = sum(((tab.flux-bg)./tab.fluxerr).^2);
        dof = height(tab) - 1;
        sigma = sqrt(chi2./dof.*sum(1./tab.fluxerr.^2));

        handles.SOPRANOS.UserData.data.bands{iband}.background = bg;
        handles.SOPRANOS.UserData.data.bands{iband}.bg.chi2 = chi2;
        handles.SOPRANOS.UserData.data.bands{iband}.bg.dof  = dof;
        handles.SOPRANOS.UserData.data.bands{iband}.bg.sigma = sigma;
               
    % estimate from the data points which are before and after the transient
    % assuming the data after the transeint already returned to its
    % background level.
    case 3
        tab = handles.SOPRANOS.UserData.data.bands{iband}.LC;
        TransientStart = str2num(handles.TransientStart.String);
        TransientEnd = str2num(handles.TransientEnd.String);
        tab = tab((tab.MJD<TransientStart | tab.MJD>TransientEnd), {'flux', 'fluxerr'});
        
        bg = sum(tab.flux./tab.fluxerr.^2)./sum(1./tab.fluxerr.^2);
        chi2 = sum(((tab.flux-bg)./tab.fluxerr).^2);
        dof = height(tab) - 1;
        sigma = sqrt(chi2./dof./sum(1./tab.fluxerr.^2));

        handles.SOPRANOS.UserData.data.bands{iband}.background = bg;
        handles.SOPRANOS.UserData.data.bands{iband}.bg.chi2 = chi2;
        handles.SOPRANOS.UserData.data.bands{iband}.bg.dof  = dof;
        handles.SOPRANOS.UserData.data.bands{iband}.bg.sigma = sigma;
    
    % case 4 use the transient data to estimate the background level.
    case 4
        handles.SOPRANOS.UserData.data.bands{iband}.background = 0;
        handles.SOPRANOS.UserData.data.bands{iband}.bg =[];
        handles.SOPRANOS.UserData.data.bands{iband}.bg.sigma = 0; 

        % The background will be estimated together with the other model
        % parameters and not independently.
end
BackgroundValue_UpdateTxt(handles.BackgroundValue, eventdata, handles);


% --- Executes during object creation, after setting all properties.
function Background_CreateFcn(hObject, eventdata, handles)
% hObject    handle to Background (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: popupmenu controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


function BackgroundValue_UpdateTxt(hObject, eventdata, handles)
% hObject    handle to BackgroundValue (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
iband = handles.BandNumber.Value;
switch handles.Background.Value
    case 1
        hObject.Enable = 'inactive';
        hObject.String = 0;
        handles.BG_sigma.Enable = 'inactive';
        handles.BG_sigma.String = 0;
    case {2,3}
        hObject.Enable = 'inactive';
        hObject.String = sprintf('%4.2e',handles.SOPRANOS.UserData.data.bands{iband}.background);
        handles.BG_sigma.Enable = 'inactive';
        handles.BG_sigma.String = sprintf('%4.2e',handles.SOPRANOS.UserData.data.bands{iband}.bg.sigma);
%        sprintf('chi2/dof: %4.2f/%2d', handles.SOPRANOS_GUI.UserData.data.bands{iband}.bg.chi2, handles.SOPRANOS_GUI.UserData.data.bands{iband}.bg.dof)};
    case 4
        hObject.Enable = 'on';
        hObject.String = handles.SOPRANOS.UserData.data.bands{iband}.background;
        handles.BG_sigma.Enable = 'on';
        handles.BG_sigma.String = handles.SOPRANOS.UserData.data.bands{iband}.bg.sigma;             
end



function BackgroundValue_Callback(hObject, eventdata, handles)
% hObject    handle to BackgroundValue (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of BackgroundValue as text
%        str2double(get(hObject,'String')) returns contents of BackgroundValue as a double
iband = handles.BandNumber.Value;
handles.SOPRANOS.UserData.data.bands{iband}.background = str2num(hObject.String);


% --- Executes on button press in RunGrid.
function RunGrid_Callback(hObject, eventdata, handles)
% hObject    handle to RunGrid (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


grid = handles.Grid.UserData;
switch handles.Prog.Value
    case 1, grid.prog = 'rsg';
    case 2, grid.prox = 'bsg';
end
switch handles.Model.Value
    case 1, grid.model = 'sw';
    case 2, grid.model = 'rw';
    case 3, grid.model = 'msw';
end
grid.sn_name = handles.SOPRANOS.UserData.data.snname;
grid.BGbands = find(handles.Background.UserData == 4);
if isempty(grid.BGbands)
    grid.BGbands = [];
    grid.BG = [];
else
    for iband=grid.BGbands(:)'
        grid.BG{iband}.value = handles.SOPRANOS.UserData.data.bands{iband}.background;
        grid.BG{iband}.sigma = handles.SOPRANOS.UserData.data.bands{iband}.bg.sigma;
    end
end
save grid grid

Save_Callback(handles.Save, eventdata, handles);
if isunix
    !screen -dmS grid nice -n 19 matlab -nodisplay -nosplash -nodesktop -r "load('grid.mat');AstroUtil.supernova.SOPRANOS.prepare_LCs(grid.sn_name,grid.model,grid.Vs.vec*10^8.5,grid.Rs.vec,grid.Ms.vec,grid.frho.vec,grid.Ebv.vec,grid.prog);AstroUtil.supernova.SOPRANOS.calcGrid(grid.sn_name, grid.t0.vec, grid.model, 0, grid.BGbands, grid.BG);exit" -logfile calcGrid.log &
elseif ispc
    !start /BELOWNORMAL matlab -nosplash -nodesktop -minimize -r "load('grid.mat');AstroUtil.supernova.SOPRANOS.prepare_LCs(grid.sn_name,grid.model,grid.Vs.vec*10^8.5,grid.Rs.vec,grid.Ms.vec,grid.frho.vec,grid.Ebv.vec,grid.prog);AstroUtil.supernova.SOPRANOS.calcGrid(grid.sn_name, grid.t0.vec, grid.model, 0, grid.BGbands, grid.BG);exit" -logfile "calcGrid.log"
end


% --- Executes on button press in PlotGrid.
function PlotGrid_Callback(hObject, eventdata, handles)
% hObject    handle to PlotGrid (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
%plotGrid([handles.SOPRANOS_GUI.UserData.data.snname '_' lower(handles.Model.String{handles.Model.Value}) '_grid'])
peakNumber = str2num(handles.PeakNumber.String);
if peakNumber<=0
    peakNumber = 1;
end
if (handles.FilterGrid.Value)
    SNdata=handles.SOPRANOS.UserData.data;
    data = table;

    for iband = 1:length(SNdata.bands)
        Tab = SNdata.bands{iband}.LC(SNdata.bands{iband}.LC.MJD>str2num(handles.TransientStart.String)&SNdata.bands{iband}.LC.MJD<(str2num(handles.TransientEnd.String)+20),:);
        bandData = table;
        bandData.time = Tab.MJD;
        bandData.flux = Tab.flux;
        bandData.fluxerr = Tab.fluxerr;
        bandData.band = repmat(string(SNdata.bands{iband}.filterObj.band),height(bandData),1);
        bandData.family = repmat(string(SNdata.bands{iband}.filterObj.family),height(bandData),1);

        data=[data; bandData];
    end

    clear bandData Tab

    epochFilter = handles.SOPRANOS.UserData.data.bands{handles.BandNumber.Value}.filterObj;
%   GridLimitMask(grid,data,FiltFam,FiltBand,redshift,t0,Rs,Vs,Ms,frho,Ebv)
    FcnParams.data = data;
    FcnParams.family = epochFilter.family;
    FcnParams.band = epochFilter.band;
    FcnParams.redshift = handles.SOPRANOS.UserData.data.redshift;
    validFcn = @(t0,Rs,Vs,Ms,frho,Ebv) GridLimitMask([],FcnParams.data,FcnParams.family,FcnParams.band,FcnParams.redshift,t0,Rs,Vs,Ms,frho,Ebv);
    AstroUtil.supernova.SOPRANOS.plotGrid([handles.SOPRANOS.UserData.data.snname '_' lower(handles.Model.String{handles.Model.Value}) '_grid'],...
        handles.MinTPoints.UserData, peakNumber, handles.FilterGrid.UserData, validFcn, FcnParams);
else
    AstroUtil.supernova.SOPRANOS.plotGrid([handles.SOPRANOS.UserData.data.snname '_' lower(handles.Model.String{handles.Model.Value}) '_grid'],...
        handles.MinTPoints.UserData, peakNumber);
end


% --- Executes on selection change in Grid.
function Grid_Callback(hObject, eventdata, handles)
% hObject    handle to Grid (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: contents = cellstr(get(hObject,'String')) returns Grid contents as cell array
%        contents{get(hObject,'Value')} returns selected item from Grid
switch hObject.Value
    case 1, str = hObject.UserData.t0;
    case 2, str = hObject.UserData.Rs;
    case 3, str = hObject.UserData.Vs;
    case 4, str = hObject.UserData.Ms;
    case 5, str = hObject.UserData.frho;
    case 6, str = hObject.UserData.Ebv;
end
switch str.method
    case 'lin'
        handles.SpanMethod.Value = 1;
    case 'log'
        handles.SpanMethod.Value = 2;
    case 'man'
        handles.SpanMethod.Value = 3;
end
SpanMethod_Callback(handles.SpanMethod,eventdata, handles);
handles.Min.String = str.min;
handles.Max.String = str.max;
handles.Steps.String = str.steps;

% --- Executes during object creation, after setting all properties.
function Grid_CreateFcn(hObject, eventdata, handles)
% hObject    handle to Grid (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: listbox controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end
hObject.UserData.t0   = struct('method','lin','min',53000,'max',53001.9,'steps',20,'vec',[]);
hObject.UserData.Rs   = struct('method','lin','min',200,'max',2000,'steps',100,'vec',[]);
hObject.UserData.Vs   = struct('method','log','min',0.5,'max',2.5,'steps',101,'vec',[]);
hObject.UserData.Ms   = struct('method','lin','min', 2, 'max', 20, 'steps', 18,'vec',[]);
hObject.UserData.frho = struct('method','log','min', sqrt(1/3), 'max', sqrt(10), 'steps', 9,'vec',[]);
hObject.UserData.Ebv  = struct('method','lin','min', 0.1, 'max', 0.2, 'steps', 11,'vec',[]);
Grid_UpdateList(hObject, 1);
Grid_UpdateList(hObject, 2);
Grid_UpdateList(hObject, 3);
Grid_UpdateList(hObject, 4);
Grid_UpdateList(hObject, 5);
Grid_UpdateList(hObject, 6);



function Grid_UpdateList(hObject, line, loadStr)
if nargin==2
    loadStr = [];
end
switch line
    case 1 %t0
        hObject.UserData.t0.vec = space(hObject.UserData.t0.method,...
                                        hObject.UserData.t0.min,...
                                        hObject.UserData.t0.max,...
                                        hObject.UserData.t0.steps,...
                                        hObject.UserData.t0.vec,'vect0',loadStr);
        hObject.String{1} = ['vect0    [',num2str(hObject.UserData.t0.vec),']'];
    case 2 %Rs
        hObject.UserData.Rs.vec = space(hObject.UserData.Rs.method,...
                                        hObject.UserData.Rs.min,...
                                        hObject.UserData.Rs.max,...
                                        hObject.UserData.Rs.steps,...
                                        hObject.UserData.Rs.vec,'vecRs',loadStr);
        hObject.String{2} = ['vecRs    [',num2str(hObject.UserData.Rs.vec),']'];
    case 3 %Vs
        hObject.UserData.Vs.vec = space(hObject.UserData.Vs.method,...
                                        hObject.UserData.Vs.min,...
                                        hObject.UserData.Vs.max,...
                                        hObject.UserData.Vs.steps,...
                                        hObject.UserData.Vs.vec,'vecVs',loadStr);
        hObject.String{3} = ['vecVs    [',num2str(hObject.UserData.Vs.vec),']'];
    case 4 %Ms
        hObject.UserData.Ms.vec = space(hObject.UserData.Ms.method,...
                                        hObject.UserData.Ms.min,...
                                        hObject.UserData.Ms.max,...
                                        hObject.UserData.Ms.steps,...
                                        hObject.UserData.Ms.vec,'vecMs',loadStr);
        hObject.String{4} = ['vecMs    [',num2str(hObject.UserData.Ms.vec),']'];
    case 5 %frho
        hObject.UserData.frho.vec = space(hObject.UserData.frho.method,...
                                        hObject.UserData.frho.min,...
                                        hObject.UserData.frho.max,...
                                        hObject.UserData.frho.steps,...
                                        hObject.UserData.frho.vec,'vecFrho',loadStr);
        hObject.String{5} = ['vecFrho  [',num2str(hObject.UserData.frho.vec),']'];
    case 6 %Ebv
        hObject.UserData.Ebv.vec = space(hObject.UserData.Ebv.method,...
                                        hObject.UserData.Ebv.min,...
                                        hObject.UserData.Ebv.max,...
                                        hObject.UserData.Ebv.steps,...
                                        hObject.UserData.Ebv.vec,'vecEbv',loadStr);
        hObject.String{6} = ['vecEbv  [',num2str(hObject.UserData.Ebv.vec),']'];                                    
end                                    
                                        
                                        


function vec = space(method, min, max, steps,vec,str,loadStr)
switch method
    case 'lin'
        vec = linspace(min, max, steps);
    case 'log'
        vec = logspace(log10(min), log10(max), steps);
    case 'man'
        if ~strcmp(loadStr,'load')
            str = inputdlg(str,'Manual Grid',[1 100], {num2str(vec)});
            vec = str2num(str{1});
        end
end

% --- Executes on selection change in SpanMethod.
function SpanMethod_Callback(hObject, eventdata, handles)
% hObject    handle to SpanMethod (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: contents = cellstr(get(hObject,'String')) returns SpanMethod contents as cell array
%        contents{get(hObject,'Value')} returns selected item from SpanMethod
switch hObject.Value
    case {1,2}
        handles.Min.Enable = 'on';
        handles.Max.Enable = 'on';
        handles.Steps.Enable = 'on';
    case 3
        handles.Min.Enable = 'off';
        handles.Max.Enable = 'off';
        handles.Steps.Enable = 'off';
end

% --- Executes during object creation, after setting all properties.
function SpanMethod_CreateFcn(hObject, eventdata, handles)
% hObject    handle to SpanMethod (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: popupmenu controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function Min_Callback(hObject, eventdata, handles)
% hObject    handle to Min (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of Min as text
%        str2double(get(hObject,'String')) returns contents of Min as a double


% --- Executes during object creation, after setting all properties.
function Min_CreateFcn(hObject, eventdata, handles)
% hObject    handle to Min (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function Max_Callback(hObject, eventdata, handles)
% hObject    handle to Max (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of Max as text
%        str2double(get(hObject,'String')) returns contents of Max as a double


% --- Executes during object creation, after setting all properties.
function Max_CreateFcn(hObject, eventdata, handles)
% hObject    handle to Max (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function Steps_Callback(hObject, eventdata, handles)
% hObject    handle to Steps (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of Steps as text
%        str2double(get(hObject,'String')) returns contents of Steps as a double


% --- Executes during object creation, after setting all properties.
function Steps_CreateFcn(hObject, eventdata, handles)
% hObject    handle to Steps (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


% --- Executes on button press in Populate.
function Populate_Callback(hObject, eventdata, handles)
% hObject    handle to Populate (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if (handles.SpanMethod.Value == 3)
    switch handles.Grid.Value
        case 1, handles.Grid.UserData.t0.method = 'man';
        case 2, handles.Grid.UserData.Rs.method = 'man';
        case 3, handles.Grid.UserData.Vs.method = 'man';
        case 4, handles.Grid.UserData.Ms.method = 'man';
        case 5, handles.Grid.UserData.frho.method = 'man';
        case 6, handles.Grid.UserData.Ebv.method = 'man';
    end
else
    method = {'lin','log','man'};
    rec.method = method{handles.SpanMethod.Value};
    rec.min = str2num(handles.Min.String);
    rec.max = str2num(handles.Max.String);
    rec.steps = str2num(handles.Steps.String);
    rec.vec = [];
    switch handles.Grid.Value
        case 1, handles.Grid.UserData.t0 = rec;
        case 2, handles.Grid.UserData.Rs = rec;
        case 3, handles.Grid.UserData.Vs = rec;
        case 4, handles.Grid.UserData.Ms = rec;
        case 5, handles.Grid.UserData.frho = rec;
        case 6, handles.Grid.UserData.Ebv = rec;
    end
end

Grid_UpdateList(handles.Grid, handles.Grid.Value);


% --- Executes on button press in Export.
function Export_Callback(hObject, eventdata, handles)
% hObject    handle to Export (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
f = figure;
if isempty(handles.Plot.UserData)
    f.Name = handles.SOPRANOS.UserData.data.snname;
else
    Plot = handles.Plot.UserData.params;
    f.Name = sprintf('%s %s model %s Rs=%4.0f Vs*,8.5=%4.2f Ms=%4.1f frho=%5.3f t0=%8.2f Ebv=%4.2f',...
        handles.SOPRANOS.UserData.data.snname, Plot.model, Plot.prog, Plot.Rs, Plot.Vs/10^8.5, Plot.Ms, Plot.frho, Plot.t0, Plot.Ebv);
end
Naxes = length(handles.Graphs.UserData);
if Naxes == 0
    return
end
for iaxes = 1:Naxes
    h=copyobj([handles.Graphs.UserData(iaxes) handles.Graphs.UserData(iaxes).Legend],f);
    haxes(iaxes) = h(1);
    hlegend(iaxes) = h(2);
    haxes(iaxes).Position(2) = haxes(iaxes).Position(2)-0.02;
    haxes(iaxes).FontSize=14;
end
linkaxes(haxes, 'x');


for iaxes = 1:Naxes
    children = haxes(iaxes).Children;
    for iChild = 1:length(children)
        if strcmp(children(iChild).Tag,'imrect')
            hGroup = children(iChild);
        end
    end
    for iChild = 1:length(hGroup.Children)
        if strcmp(hGroup.Children(iChild).Tag,'patch')
            hPatch = hGroup.Children(iChild);
        end
    end
    hPatch.Parent = haxes(iaxes);
    delete(hGroup)
    hPatch.FaceColor = [0.7 0.7 0.7];
    hPatch.FaceAlpha = 0.3;
    hPatch.LineStyle = 'none';
    hPatch.DisplayName = 'UV Transient';
    haxes(iaxes).Box = 'on';
    children = haxes(iaxes).Children;
    haxes(iaxes).Children = [children(2:end); children(1)];
    legend(haxes(iaxes).Children(1:end-1));
end


% --- Executes on button press in Residuals.
function Residuals_Callback(hObject, eventdata, handles)
% hObject    handle to Residuals (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
f = figure;
Plot = handles.Plot.UserData.params;
f.Name = sprintf('%s residuals %s model %s Rs=%4.0f Vs*,8.5=%4.2f Ms=%4.1f frho=%5.3f t0=%8.2f Ebv=%4.2f',...
    handles.SOPRANOS.UserData.data.snname, Plot.model, Plot.prog, Plot.Rs, Plot.Vs/10^8.5, Plot.Ms, Plot.frho, Plot.t0, Plot.Ebv);

Naxes = length(handles.Graphs.UserData);
if Naxes == 0
    return
end

for iaxes=1:Naxes
    h(iaxes)=subplot(Naxes,1,iaxes);
    h(iaxes).Box = 'on';
end

pos1 = h(1).Position;
posEnd = h(end).Position;
height = (pos1(2)+pos1(4)-posEnd(2))/Naxes;
pos = [posEnd(1) posEnd(2) posEnd(3) height];
for iaxes = 1:Naxes
    h(Naxes+1-iaxes).Position = pos;
    pos(2)=pos(2)+height;
end
    
[~,~,~,~,~,t_min,t_max,t_opac,~,t_delta] = AstroUtil.supernova.sn_cooling_sw(1,'Model',Plot.model,'Type',Plot.prog,...
    'Rs',Plot.Rs,'Vs',Plot.Vs,'Ms',Plot.Ms,'f_rho',Plot.frho);
z = Plot.redshift;
t_min = t_min*(1+z);
switch Plot.model
    case 'SW'
        t_max = min(t_max,t_opac)*(1+z);
    case 'RW'
        t_max = min(t_delta,t_opac)*(1+z);
    case 'MSW'
        [~,~,~,~,~,t_min,t_max] = AstroUtil.supernova.sn_cooling_msw(1,'Model',Plot.model,'Type',Plot.prog,...
            'Rs',Plot.Rs,'Vs',Plot.Vs,'Ms',Plot.Ms,'f_rho',Plot.frho);
        t_min = t_min*(1+z);
        t_max = t_max*(1+z);
end

for iband = 1:length(handles.PlottedInGraph.UserData)
    if handles.Background.UserData(iband) ~= 1
        bg(iband) = handles.SOPRANOS.UserData.data.bands{iband}.background;
    else
        bg(iband) = 0;
    end
    data = handles.SOPRANOS.UserData.data.bands{iband}.LC;
    data = data(data.MJD>=(Plot.t0+t_min)&data.MJD<=(Plot.t0+t_max),:);  
    if any(ismember(data.Properties.VariableNames,'outliers'))
        data = data(~data.outliers,:);
    end
    if ~isempty(data)
        ax = h(handles.PlottedInGraph.UserData(iband));
        switch Plot.model
            case {'SW','RW'}
                [~,~,~,~,Mag] = AstroUtil.supernova.sn_cooling_sw(data.MJD-Plot.t0,'Model',Plot.model,'Type',Plot.prog,...
                    'Rs',Plot.Rs,'Vs',Plot.Vs,'Ms',Plot.Ms,'f_rho',Plot.frho, ...
                    'redshift',z,'Ebv',Plot.Ebv,'FiltFam',handles.SOPRANOS.UserData.data.bands{iband}.filterObj);
            case 'MSW'
                [~,~,~,~,Mag] = AstroUtil.supernova.sn_cooling_msw(data.MJD-Plot.t0,'Model',Plot.model,'Type',Plot.prog,...
                    'Rs',Plot.Rs,'Vs',Plot.Vs,'Ms',Plot.Ms,'f_rho',Plot.frho, ...
                    'redshift',z,'Ebv',Plot.Ebv,'FiltFam',handles.SOPRANOS.UserData.data.bands{iband}.filterObj);
        end
        f = convert.flux(Mag,'ab','cgs/A',handles.SOPRANOS.UserData.data.bands{iband}.filterObj.pivot_wl_photon,'A');
        res = data.flux-f-bg(iband);
        if isempty(handles.BandName.UserData{iband})
            name = sprintf('%s %s',handles.SOPRANOS.UserData.data.bands{iband}.instrumentname,handles.SOPRANOS.UserData.data.bands{iband}.filtername);
        else
            name = handles.BandName.UserData{iband};
        end
        for iChild = 1:length(handles.Graphs.UserData(handles.PlottedInGraph.UserData(iband)).Children)
            if strcmpi(handles.Graphs.UserData(handles.PlottedInGraph.UserData(iband)).Children(iChild).DisplayName,name)
                Color(iband,:) = handles.Graphs.UserData(handles.PlottedInGraph.UserData(iband)).Children(iChild).Color;
            end
        end
        errorbar(ax,data.MJD,res,data.fluxerr,'o','Color',Color(iband,:),'MarkerFaceColor','auto','DisplayName',[name ' residuals']);
        hold(ax,'on')
    end
end


for iband = 1:length(handles.PlottedInGraph.UserData)
    ax = h(handles.PlottedInGraph.UserData(iband));
    data = handles.SOPRANOS.UserData.data.bands{iband}.LC;
    switch handles.Background.UserData(iband)
        case 1        % zero - no background residuals required to be plotted
            continue
        case 2        % estimate from data points before the transient
            data = data(data.MJD<str2num(handles.TransientStart.String),:);               
        case 3        % estimate from data points before and after the transient
            data = data(data.MJD<str2num(handles.TransientStart.String)|data.MJD>str2num(handles.TransientEnd.String),:);    
        case 4        % estimate together with the mode - no special residual plot is required.
            continue
    end
    res = data.flux-bg(iband);
    errorbar(ax,data.MJD,res,data.fluxerr,'o','Color',Color(iband,:),'DisplayName',[name 'background residuals']);
end
    
h(Naxes).XAxis.Exponent = 0;
for iaxes=1:Naxes-1
    h(iaxes).XTickLabel = [];
end
linkaxes(h,'x');
for iaxes=1:Naxes
    axes(h(iaxes));
    children = h(iaxes).Children; 
    line(xlim,[0 0],'Color','k');
    legend(children);
end

xlabel(h(Naxes),'MJD [days]');
hlab=ylabel(h(ceil(Naxes/2)), 'Residual flux [$erg\,s^{-1}\,cm^{-2}\,\AA^{-1}$]','Interpreter','LATEX','FontSize',14);
hlab.Units = 'normal';
if rem(Naxes,2)==0
   pos=h(Naxes/2).YLabel.Position;
   pos(2)=0;
   h(Naxes/2).YLabel.Position=pos;
end


function RedShift_Callback(hObject, eventdata, handles)
% hObject    handle to RedShift (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of RedShift as text
%        str2double(get(hObject,'String')) returns contents of RedShift as a double
handles.SOPRANOS.UserData.data.redshift = str2num(hObject.String);

% --- Executes during object creation, after setting all properties.
function RedShift_CreateFcn(hObject, eventdata, handles)
% hObject    handle to RedShift (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function RA_Callback(hObject, eventdata, handles)
% hObject    handle to RA (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of RA as text
%        str2double(get(hObject,'String')) returns contents of RA as a double


% --- Executes during object creation, after setting all properties.
function RA_CreateFcn(hObject, eventdata, handles)
% hObject    handle to RA (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function dec_Callback(hObject, eventdata, handles)
% hObject    handle to dec (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of dec as text
%        str2double(get(hObject,'String')) returns contents of dec as a double
try
    decRad = celestial.coo.convertdms(hObject.String,'SD','r');
catch
    hObject.String = handles.SOPRANOS.UserData.data.decd;
end
handles.SOPRANOS.UserData.data.decd = hObject.String;
hadnles.SOPRANOS.UserData.data.decRad

% --- Executes during object creation, after setting all properties.
function dec_CreateFcn(hObject, eventdata, handles)
% hObject    handle to dec (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function BandName_Callback(hObject, eventdata, handles)
% hObject    handle to BandName (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of BandName as text
%        str2double(get(hObject,'String')) returns contents of BandName as a double
iBand = handles.BandNumber.Value;
hObject.UserData{iBand} = hObject.String;
handles.BandNumber.String{iBand} = sprintf('%d - %s',iBand,hObject.String);
Graphs_PlotPoints(handles);
MinTPointsBand_UpdateText(handles.MinTPointsBand, eventdata, handles);

% --- Executes during object creation, after setting all properties.
function BandName_CreateFcn(hObject, eventdata, handles)
% hObject    handle to BandName (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


% --- Executes on selection change in MinTPointsBand.
function MinTPointsBand_Callback(hObject, eventdata, handles)
% hObject    handle to MinTPointsBand (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: contents = cellstr(get(hObject,'String')) returns MinTPointsBand contents as cell array
%        contents{get(hObject,'Value')} returns selected item from MinTPointsBand


% --- Executes during object creation, after setting all properties.
function MinTPointsBand_CreateFcn(hObject, eventdata, handles)
% hObject    handle to MinTPointsBand (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: popupmenu controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


function MinTPointsBand_UpdateText(hObject, eventdata, handles)
% hObject    handle to MinTPointsBand (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of MinTPoints as text
%        str2double(get(hObject,'String')) returns contents of MinTPoints as a double
bandStr = handles.BandName.UserData;
for iband = 1:length(handles.BandName.UserData)
    if isempty(bandStr{iband})
        bandStr{iband} = sprintf('$s %s - %d', handles.SOPRANOS.UserData.data.bands{iband}.instrumentname, ...
            handles.SOPRANOS.UserData.data.bands{iband}.filtername, handles.MinTPoints.UserData(iband));
    else
        bandStr{iband} = sprintf('%s - %d',bandStr{iband},handles.MinTPoints.UserData(iband));
    end
end
hObject.String = bandStr;

function MinTPoints_Callback(hObject, eventdata, handles)
% hObject    handle to MinTPoints (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of MinTPoints as text
%        str2double(get(hObject,'String')) returns contents of MinTPoints as a double
hObject.UserData(handles.MinTPointsBand.Value) = str2num(hObject.String);
MinTPointsBand_UpdateText(handles.MinTPointsBand, eventdata, handles)

% --- Executes during object creation, after setting all properties.
function MinTPoints_CreateFcn(hObject, eventdata, handles)
% hObject    handle to MinTPoints (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end



function PeakNumber_Callback(hObject, eventdata, handles)
% hObject    handle to PeakNumber (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of PeakNumber as text
%        str2double(get(hObject,'String')) returns contents of PeakNumber as a double

% --- Executes during object creation, after setting all properties.
function PeakNumber_CreateFcn(hObject, eventdata, handles)
% hObject    handle to PeakNumber (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


function BG_sigma_Callback(hObject, eventdata, handles)
% hObject    handle to BG_sigma (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of BG_sigma as text
%        str2double(get(hObject,'String')) returns contents of BG_sigma as a double
iband = handles.BandNumber.Value;
handles.SOPRANOS.UserData.data.bands{iband}.bg.sigma = str2num(hObject.String);


% --- Executes during object creation, after setting all properties.
function BG_sigma_CreateFcn(hObject, eventdata, handles)
% hObject    handle to BG_sigma (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


% --- Executes on button press in PhotoFit.
% Estimate Blackbody radius and temperature out of data
function PhotoFit_Callback(hObject, eventdata, handles)
% hObject    handle to Photofit (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Generate an input table for photoFit function
SNdata=handles.SOPRANOS.UserData.data;
data = table;
for iband = 1:length(SNdata.bands)
    Tab = SNdata.bands{iband}.LC(SNdata.bands{iband}.LC.MJD>str2num(handles.TransientStart.String)&SNdata.bands{iband}.LC.MJD<(str2num(handles.TransientEnd.String)+20),:);
    bandData = table;
    bandData.time = Tab.MJD;
    bandData.flux = Tab.flux;
    bandData.fluxerr = Tab.fluxerr;
    bandData.band = repmat(string(SNdata.bands{iband}.filterObj.band),height(bandData),1);
    bandData.family = repmat(string(SNdata.bands{iband}.filterObj.family),height(bandData),1);
    
    data=[data; bandData];
end

clear bandData Tab

epochFilter = handles.SOPRANOS.UserData.data.bands{handles.BandNumber.Value}.filterObj;
[Rbb,Tbb,epochs,sigmaRbbp,sigmaRbbm,sigmaTbbp,sigmaTbbm,chi2,dof,reject]=photoFit(data,'epochFam',epochFilter.family,'epochBand',epochFilter.band,'redshift',SNdata.redshift,'RA',SNdata.RAh,'dec',SNdata.decd);
figure;
err=errorbar(epochs(~reject),Rbb(~reject),sigmaRbbm(~reject),sigmaRbbp(~reject),'o-');
err.MarkerFaceColor=err.MarkerEdgeColor;
if any(reject)
    hold on
    rej=errorbar(epochs(reject),Rbb(reject),sigmaRbbm(reject),sigmaRbbp(reject),'o');
    rej.Color=err.Color;
end
ylabel('Effective R_{BB} [cm]');
xlabel('MJD [days]');
xl=xlim;xl(1)=xl(1)-1;xlim(xl);
ax=gca;
ax.XAxis.Exponent=0;

figure;
err=errorbar(epochs(~reject),Tbb(~reject),sigmaTbbm(~reject),sigmaTbbp(~reject),'o-');
err.MarkerFaceColor=err.MarkerEdgeColor;
if any(reject)
    hold on
    rej=errorbar(epochs(reject),Tbb(reject),sigmaTbbm(reject),sigmaTbbp(reject),'o');
    rej.Color=err.Color;
end
ylabel('T_{Col,BB} [eV]');
xlabel('MJD [days]');
xl=xlim;xl(1)=xl(1)-1;xlim(xl);
ax=gca;
ax.XAxis.Exponent=0;
ax.YScale = 'log';

fprintf('MJD                & $\\chi^2/dof$ & Significance & $R_{BB} $ & $ \\sigma_R_{BB} & $T_{BB}$ & $\\sigma_T_{BB}$ \\\\ \n');
for iepoch = 1:length(epochs)
   fprintf('%8.2f & %5.2f/%1d & %4.2f & %4.0f & %3.0f & %3.1f & %4.2f \\\\ \n',...
       epochs(iepoch), chi2(iepoch), dof, 1-chi2cdf(chi2(iepoch), dof), ...
       Rbb(iepoch)/constant.SunR, sigmaRbbp(iepoch)/constant.SunR, ...
       Tbb(iepoch), sigmaTbbp(iepoch));
end


Tab = table;
Tab.time = epochs;
Tab.Rbb  = Rbb;
Tab.Tbb  = Tbb;
Tab.sigmaRbbp = sigmaRbbp;
Tab.sigmaRbbm = sigmaRbbm;
Tab.sigmaTbbp = sigmaTbbp;
Tab.sigmaTbbm = sigmaTbbm;
Tab.chi2     = chi2;
Tab.dof      = dof*ones(height(Tab),1);
Tab.reject   = reject;
hObject.UserData = Tab;


% --- Executes on button press in PlotPhotoFit.
function PlotPhotoFit_Callback(hObject, eventdata, handles)
% hObject    handle to PlotPhotoFit (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

%fitResult = handles.PhotoFit.UserData;
model =  cell2mat(handles.Model.String(handles.Model.Value));
prog  =  cell2mat(handles.Prog.String(handles.Prog.Value));
Rs    =  str2num(handles.Rs.String);
Vs    =  str2num(handles.Vs.String)*10^8.5;
Ms    =  str2num(handles.Ms.String);
frho  =  str2num(handles.frho.String);
t0    =  str2num(handles.t0.String);
Ebv   =  str2num(handles.Ebv.String);
z     =  handles.SOPRANOS.UserData.data.redshift;

SNdata=handles.SOPRANOS.UserData.data;
data = table;
for iband = 1:length(SNdata.bands)
%     Tab = SNdata.bands{iband}.LC(SNdata.bands{iband}.LC.MJD>str2num(handles.TransientStart.String)&SNdata.bands{iband}.LC.MJD<(str2num(handles.TransientEnd.String)+20),:);
    Tab = SNdata.bands{iband}.LC(SNdata.bands{iband}.LC.MJD<(str2num(handles.TransientEnd.String)+20),:);
    bandData = table;
    bandData.time = Tab.MJD;
    bandData.flux = Tab.flux;
    bandData.fluxerr = Tab.fluxerr;
    bandData.band = repmat(string(SNdata.bands{iband}.filterObj.band),height(bandData),1);
    bandData.family = repmat(string(SNdata.bands{iband}.filterObj.family),height(bandData),1);
    
    data=[data; bandData];
end

clear bandData Tab

epochFilter = handles.SOPRANOS.UserData.data.bands{handles.BandNumber.Value}.filterObj;
%[Rbb,Tbb,epochs,sigmaRbb,sigmaTbb,chi2]=photoFit(data,'epochFam',epochFilter.family,'epochBand',epochFilter.band,'redshift',SNdata.redshift,'Ebv',Ebv);
[Rbb,Tbb,epochs,sigmaRbbp,sigmaRbbm,sigmaTbbp,sigmaTbbm,chi2,dof,reject, ext, extSigma, extChi2, extDof, extValid, bands]=...
    photoFit(data,'epochFam',epochFilter.family,'epochBand',epochFilter.band,'redshift',SNdata.redshift,'Ebv',Ebv,'BBplot',true);

% Time = (max(0.1,fitResult.time(1)-0.25):0.1:fitResult.time(end))-t0;
[~,~,~,~,~,t_min,t_max,t_opac]=AstroUtil.supernova.sn_cooling_sw(1,'Model',model,'Type',prog,'Rs',Rs,'Vs',Vs,'Ms',Ms,'f_rho',frho,'redshift',z);
Time = linspace(t_min,min(t_max,t_opac),50)*(1+z);
[~,Tc,R,~,~,~,~,~,~,~,R_BO]=AstroUtil.supernova.sn_cooling_sw(Time,'Model',model,'Type',prog,'Rs',Rs,'Vs',Vs,'Ms',Ms,'f_rho',frho,'redshift',z);
if epochs(1)<(t0+t_min)
    TimeBO = linspace(epochs(1)-t0-0.25,t_min*(1+z),50);
    [~,TcBO,~,~,~,~,~,~,~,~,R_BO]=AstroUtil.supernova.sn_cooling_sw(TimeBO,'Model',model,'Type',prog,'Rs',Rs,'Vs',Vs,'Ms',Ms,'f_rho',frho,'redshift',z);
    BO = true;
else
    BO = false;
end

figure;
% errorbar(fitResult.time,fitResult.Rbb,fitResult.sigmaRbb,'o');
%errorbar(epochs,Rbb,sigmaRbb,'o');
err=errorbar(epochs(~reject),Rbb(~reject),sigmaRbbm(~reject),sigmaRbbp(~reject),'ko');
err.MarkerFaceColor=err.MarkerEdgeColor;
hold on
if any(reject)
    rej=errorbar(epochs(reject),Rbb(reject),sigmaRbbm(reject),sigmaRbbp(reject),'ko');
    rej.Color=err.Color;
end
xl=xlim;xl(1)=xl(1)-1;xlim(xl);
plot(t0+Time,R,'k-');
if BO
    plot(t0+TimeBO,R_BO,'k--');
end
ylabel('Effective R_{BB} [cm]');
xlabel('MJD [days]');
ax=gca;
ax.XAxis.Exponent=0;

figure;
% errorbar(fitResult.time,fitResult.Tbb,fitResult.sigmaTbb,'o');
%errorbar(epochs,Tbb,sigmaTbb,'o');
err=errorbar(epochs(~reject),Tbb(~reject),sigmaTbbm(~reject),sigmaTbbp(~reject),'ko');
err.MarkerFaceColor=err.MarkerEdgeColor;
hold on
if any(reject)
    rej=errorbar(epochs(reject),Tbb(reject),sigmaTbbm(reject),sigmaTbbp(reject),'ko');
    rej.Color=err.Color;
end
xl=xlim;xl(1)=xl(1)-1;xlim(xl);
plot(t0+Time,convert.energy('T','eV',Tc),'k-');
if BO
    plot(t0+TimeBO,convert.energy('T','eV',TcBO),'k--');
end
xlabel('MJD [days]');
ax=gca;
ax.XAxis.Exponent=0;
ax.YScale = 'log';
ylabel('T_{Col,BB} [eV]');

fprintf('MJD   & $\\chi^2/dof$ & $\\alpha$ & $R_{BB} $ & $T_{BB}$ \\\\ \n');
fprintf('$[\\rm days]$&        &          & $[10^{14}\rm cm]$ &[eV] \\\\ \n');
for iepoch = 1:length(epochs)
   fprintf('%8.2f & %5.2f/%1d & %4.2f & %4.2f\\pm %4.2f & %3.1f\\pm %4.2f \\\\ \n',...
       epochs(iepoch), chi2(iepoch), dof, 1-chi2cdf(chi2(iepoch), dof), ...
       Rbb(iepoch)/1e14, sigmaRbbp(iepoch)/1e14, ...
       Tbb(iepoch), sigmaTbbp(iepoch));
end

extMag  = -2.5*log10(ext);
extMagS = abs(2.5/log(10)*extSigma./ext);

fprintf('\n');
fprintf('band & A               &  $\\chi^2/dof \\\\ \n');
for iband=1:height(bands)
%     fprintf('%4s & $%4.2f\\pm %4.2f$ & %4.2f/%1d \\\\ \n',...
%         bands.band(iband), ext(iband), extSigma(iband), extChi2(iband), extDof(iband));
    fprintf('%4s & $%4.2f\\pm %4.2f$ & %4.2f/%1d \\\\ \n',...
        bands.band(iband), extMag(iband), extMagS(iband), extChi2(iband), extDof(iband));
end

% --- Executes on button press in GridRbbFilter.
function GridRbbFilter_Callback(hObject, eventdata, handles)
% hObject    handle to GridRbbFilter (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
grid = handles.Grid.UserData;
switch handles.Prog.Value
    case 1, grid.prog = 'rsg';
    case 2, grid.prox = 'bsg';
end
switch handles.Model.Value
    case 1, grid.model = 'sw';
    case 2, grid.model = 'rw';
    case 3, grid.model = 'msw';
end
grid.sn_name = handles.SOPRANOS.UserData.data.snname;
grid.BGbands = find(handles.Background.UserData == 4);
if isempty(grid.BGbands)
    grid.BGbands = [];
    grid.BG = [];
else
    for iband=grid.BGbands(:)'
        grid.BG{iband}.value = handles.SOPRANOS.UserData.data.bands{iband}.background;
        grid.BG{iband}.sigma = handles.SOPRANOS.UserData.data.bands{iband}.bg.sigma;
    end
end

SNdata=handles.SOPRANOS.UserData.data;
data = table;

for iband = 1:length(SNdata.bands)
    Tab = SNdata.bands{iband}.LC(SNdata.bands{iband}.LC.MJD>str2num(handles.TransientStart.String)&SNdata.bands{iband}.LC.MJD<(str2num(handles.TransientEnd.String)+20),:);
    bandData = table;
    bandData.time = Tab.MJD;
    bandData.flux = Tab.flux;
    bandData.fluxerr = Tab.fluxerr;
    bandData.band = repmat(string(SNdata.bands{iband}.filterObj.band),height(bandData),1);
    bandData.family = repmat(string(SNdata.bands{iband}.filterObj.family),height(bandData),1);
    
    data=[data; bandData];
end

clear bandData Tab

epochFilter = handles.SOPRANOS.UserData.data.bands{handles.BandNumber.Value}.filterObj;
mask=GridLimitMask(grid,data,epochFilter.family,epochFilter.band,str2num(handles.RedShift.String));
handles.FilterGrid.UserData = mask;
%save grid grid

% Save_Callback(handles.Save, eventdata, handles);
% !screen -dmS grid nice -n 19 matlab -nodisplay -nosplash -nodesktop -r "load('grid.mat');prepare_LCs(grid.sn_name,grid.model,grid.Vs.vec*10^8.5,grid.Rs.vec,grid.Ms.vec,grid.frho.vec,grid.Ebv.vec,grid.prog);AstroUtil.supernova.SOPRANOS.calcGrid(grid.sn_name, grid.t0.vec, grid.model, 0, grid.BGbands, grid.BG);exit" &
 

% --- Executes on button press in FilterGrid.
function FilterGrid_Callback(hObject, eventdata, handles)
% hObject    handle to FilterGrid (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hint: get(hObject,'Value') returns toggle state of FilterGrid
if (hObject.Value && isempty(hObject.UserData))
    GridRbbFilter_Callback(handles.GridRbbFilter, eventdata, handles)
end
    

% --- Creates and returns a handle to the GUI figure.
function h1 = SOPRANOS_GUI_LayoutFcn(policy)
% policy - create a new figure or use a singleton. 'new' or 'reuse'.

persistent hsingleton;
if strcmpi(policy, 'reuse') & ishandle(hsingleton)
    h1 = hsingleton;
    return;
end
% load SOPRANOS_GUI.mat
load([mfilename('fullpath') '.mat'])

appdata = [];
appdata.GUIDEOptions = struct(...
    'active_h', [], ...
    'taginfo', struct(...
    'figure', 2, ...
    'text', 32, ...
    'axes', 2, ...
    'uitable', 2, ...
    'uibuttongroup', 2, ...
    'radiobutton', 4, ...
    'popupmenu', 8, ...
    'pushbutton', 18, ...
    'edit', 20, ...
    'uipanel', 8, ...
    'checkbox', 3, ...
    'listbox', 2), ...
    'override', 0, ...
    'release', [], ...
    'resize', 'none', ...
    'accessibility', 'callback', ...
    'mfile', 1, ...
    'callbacks', 1, ...
    'singleton', 1, ...
    'syscolorfig', 1, ...
    'blocking', 0, ...
    'lastSavedFile', '/raid/noamg/MAAT/+AstroUtil/+supernova/+SOPRANOS/SOPRANOS_GUI.m', ...
    'lastFilename', '/raid/noamg/MAAT/+AstroUtil/+supernova/+SOPRANOS/SOPRANOS.fig');
appdata.lastValidTag = 'SOPRANOS';
appdata.GUIDELayoutEditor = [];
appdata.initTags = struct(...
    'handle', [], ...
    'tag', 'SOPRANOS');

h1 = figure(...
'Units','characters',...
'Position',[135.8 16.801282051282 242.333333333333 67.5833333333333],...
'Visible',get(0,'defaultfigureVisible'),...
'Color',get(0,'defaultfigureColor'),...
'CurrentAxesMode','manual',...
'IntegerHandle','off',...
'MenuBar','none',...
'Name','SOPRANOS',...
'NumberTitle','off',...
'HandleVisibility','callback',...
'Tag','SOPRANOS',...
'Resize','off',...
'PaperPosition',get(0,'defaultfigurePaperPosition'),...
'ScreenPixelsPerInchMode','manual',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'FilePanel';

h2 = uipanel(...
'Parent',h1,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','characters',...
'Title',blanks(0),...
'Tag','FilePanel',...
'Position',[8.16666666666667 0.666666666666676 83.5 7.58333333333333],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'TransientPanel';

h3 = uipanel(...
'Parent',h1,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','characters',...
'Title',blanks(0),...
'Tag','TransientPanel',...
'Position',[8.16666666666667 8.41666666666667 83.5 4],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'Table';

h4 = uitable(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuitableFontUnits'),...
'BackgroundColor',get(0,'defaultuitableBackgroundColor'),...
'ColumnName',get(0,'defaultuitableColumnName'),...
'ColumnWidth',{  'auto' 'auto' },...
'Data',{  blanks(0) []; blanks(0) []; blanks(0) []; blanks(0) [] },...
'RowName',blanks(0),...
'Position',[99.8333333333333 18.25 135.666666666667 40.1666666666667],...
'ColumnEditable',mat{1},...
'ColumnFormat',{  [] 'short g' },...
'RearrangeableColumns',get(0,'defaultuitableRearrangeableColumns'),...
'RowStriping',get(0,'defaultuitableRowStriping'),...
'CellEditCallback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Table_CellEditCallback',hObject,eventdata,guidata(hObject)),...
'CellSelectionCallback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Table_CellSelectionCallback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuitableForegroundColor'),...
'Enable',get(0,'defaultuitableEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuitableVisible'),...
'HandleVisibility',get(0,'defaultuitableHandleVisibility'),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Table',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'FontSize',get(0,'defaultuitableFontSize'),...
'FontName',get(0,'defaultuitableFontName'),...
'FontAngle',get(0,'defaultuitableFontAngle'),...
'FontWeight',get(0,'defaultuitableFontWeight'));

appdata = [];
appdata.lastValidTag = 'GraphsNumber';

h5 = uibuttongroup(...
'Parent',h1,...
'FontUnits','points',...
'Units','characters',...
'SelectionChangeFcn',@(hObject,eventdata)SOPRANOS('GraphsNumber_SelectionChangedFcn',get(hObject,'SelectedObject'),eventdata,guidata(get(hObject,'SelectedObject'))),...
'Title','Number of Graphs:',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','GraphsNumber',...
'Position',[8.16666666666667 59.9166666666667 27.1666666666667 3.41666666666666]);

appdata = [];
appdata.lastValidTag = 'OneGraph';

h6 = uicontrol(...
'Parent',h5,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','1',...
'Style','radiobutton',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[3 0.416666666666667 5.33333333333333 1.41666666666667],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','OneGraph');

appdata = [];
appdata.lastValidTag = 'TwoGraphs';

h7 = uicontrol(...
'Parent',h5,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'String','2',...
'Style','radiobutton',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[11.1666666666667 0.416666666666667 5.33333333333333 1.41666666666667],...
'Callback',blanks(0),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','TwoGraphs',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'ThreeGraphs';

h8 = uicontrol(...
'Parent',h5,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'String','3',...
'Style','radiobutton',...
'Value',1,...
'Position',[19.5 0.333333333333333 5.33333333333333 1.58333333333333],...
'Callback',blanks(0),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ThreeGraphs',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'BandNumber';

h9 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Band Number',...
'Style','popupmenu',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[112.166666666667 60 21.1666666666667 2.5],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('BandNumber_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('BandNumber_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','BandNumber');

appdata = [];
appdata.lastValidTag = 'BandText';

h10 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','Band:',...
'Style','text',...
'Position',[99.8333333333333 60.25 6.66666666666667 2.25],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','BandText');

appdata = [];
appdata.lastValidTag = 'PlottedInGraph';

h11 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Max',3,...
'Min',1,...
'String',{  '1'; '2'; '3' },...
'Style','popupmenu',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[155.666666666667 60.3333333333333 6.0 2.16666666666666],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('PlottedInGraph_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('PlottedInGraph_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','PlottedInGraph');

appdata = [];
appdata.lastValidTag = 'PlottedInGraphText';

h12 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','Plotted in graph:',...
'Style','text',...
'Position',[136.333333333333 60.25 14 2.25],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','PlottedInGraphText');

appdata = [];
appdata.lastValidTag = 'Load';

h13 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Load Data File',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[9.66666666666667 4.91666666666668 23.6666666666667 2.66666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Load_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','Load');

appdata = [];
appdata.lastValidTag = 'NewDataFile';

h14 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Generate Raw Data File',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[36.3333333333333 4.91666666666668 25.1666666666667 2.66666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('NewDataFile_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','NewDataFile',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'Save';

h15 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Save Data File',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[9.83333333333333 1.58333333333334 23.5 2.66666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Save_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Save',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'Transient';

h16 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Set Transient Area',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[9.66666666666667 9.16666666666667 23.6666666666667 2.66666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Transient_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Transient',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'TransientStartText';

h17 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Transient Start:',...
'Style','text',...
'Position',[37 9.08333333333334 15 2.08333333333333],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','TransientStartText');

appdata = [];
appdata.lastValidTag = 'TransientStart';

h18 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','TransientStart',...
'Style','edit',...
'Position',[52.5 9.41666666666667 12.8333333333333 2.16666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('TransientStart_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('TransientStart_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','TransientStart');

appdata = [];
appdata.lastValidTag = 'TransientEndText';

h19 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Transient End:',...
'Style','text',...
'Position',[66.5 9.16666666666667 12 2.08333333333333],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','TransientEndText');

appdata = [];
appdata.lastValidTag = 'TransientEnd';

h20 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','TransientEnd',...
'Style','edit',...
'Position',[78.6666666666667 9.50000000000001 12.8333333333333 2.16666666666666],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('TransientEnd_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('TransientEnd_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','TransientEnd',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'SaveSettings';

h21 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Save GUI Settings',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[66.5 1.58333333333334 23 2.66666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('SaveSettings_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','SaveSettings',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'Graphs';

h22 = uipanel(...
'Parent',h1,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','characters',...
'Title','Graphs',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','Graphs',...
'Position',[8.16666666666667 13.25 83.5 45.9166666666667]);

appdata = [];
appdata.lastValidTag = 'Export';

h23 = uicontrol(...
'Parent',h22,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Export',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[0.833333333333333 0.833333333333333 17.3333333333333 2],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Export_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','Export');

appdata = [];
appdata.lastValidTag = 'Residuals';

h24 = uicontrol(...
'Parent',h22,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Plot Residuals',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[19.5 0.833333333333333 17 2],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Residuals_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Residuals',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'LoadSettings';

h25 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Load GUI Settings',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[66.5 5.00000000000001 23.3333333333333 2.66666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('LoadSettings_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','LoadSettings',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'ModelParams';

h26 = uipanel(...
'Parent',h1,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','characters',...
'Title','Plot Model',...
'Tag','ModelParams',...
'Position',[99.8333333333333 4.91666666666667 79.3333333333333 12.5833333333333],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'ModelText';

h27 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','Model:',...
'Style','text',...
'Position',[3 8.16666666666667 10 2],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','ModelText');

appdata = [];
appdata.lastValidTag = 'Model';

h28 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String',{  'SW'; 'RW' ; 'MSW' },...
'Style','popupmenu',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[20.1666666666667 8.08333333333333 8.5 2.08333333333333],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Model_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Model_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','Model');

appdata = [];
appdata.lastValidTag = 'ProgText';

h29 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','Progenitor:',...
'Style','text',...
'Position',[31 8.16666666666667 10 2],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ProgText');

appdata = [];
appdata.lastValidTag = 'Prog';

h30 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String',{  'RSG'; 'BSG' },...
'Style','popupmenu',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[44.6666666666667 8.08333333333333 8.5 2.08333333333333],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Prog_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Prog_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Prog',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'RsText';

h31 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','R_{prog }[R_{\sun}]:',...
'Style','text',...
'Position',[2.83333333333333 5.16666666666667 18.1666666666667 2],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','RsText');

appdata = [];
appdata.lastValidTag = 'Rs';

h32 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','1000',...
'Style','edit',...
'Position',[20 5.83333333333333 8.66666666666666 1.91666666666667],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','Rs');

appdata = [];
appdata.lastValidTag = 'vsText';

h33 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','v_{s*,8.5}:',...
'Style','text',...
'Position',[30.8333333333333 5.33333333333333 10 2],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','vsText');

appdata = [];
appdata.lastValidTag = 'Vs';

h34 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','1.002',...
'Style','edit',...
'Position',[44.5 5.83333333333333 8.66666666666666 1.91666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Vs_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Vs_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Vs',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'MsText';

h35 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','M_{ej} [M_{\sun}]:',...
'Style','text',...
'Position',[2.83333333333333 2.83333333333333 16.3333333333333 2],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','MsText');

appdata = [];
appdata.lastValidTag = 'Ms';

h36 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','16.4',...
'Style','edit',...
'Position',[20 3.5 8.667 1.91666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Ms_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Ms_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Ms',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'frhoText';

h37 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','f_{\rho}:',...
'Style','text',...
'Position',[31 3.5 10 2],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','frhoText');

appdata = [];
appdata.lastValidTag = 'frho';

h38 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','1.000',...
'Style','edit',...
'Position',[44.5 3.5 8.66666666666666 1.91666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('frho_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('frho_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','frho',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 't0text';

h39 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','t_{\ref}:',...
'Style','text',...
'Position',[2.83333333333333 0.0833333333333333 16.3333333333333 2],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','t0text');

appdata = [];
appdata.lastValidTag = 't0';

h40 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','54326.45',...
'Style','edit',...
'Position',[20 0.66666666666667 8.66666666666666 1.91666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('t0_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('t0_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','t0',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'EbvText';

h41 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','E_{B-V}:',...
'Style','text',...
'Position',[31.1666666666667 0.166666666666666 10 2],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','EbvText');

appdata = [];
appdata.lastValidTag = 'Ebv';

h42 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','0.235',...
'Style','edit',...
'Position',[44.5 0.66666666666667 8.66666666666666 1.91666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Ebv_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Ebv_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Ebv',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'Plot';

h43 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Plot Graph',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[58.1666666666667 7.91666666666667 16.8333333333333 2.25],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Plot_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','Plot');

appdata = [];
appdata.lastValidTag = 'Clear';

h44 = uicontrol(...
'Parent',h26,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Clear Graph',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[58 4.916666666666667 16.8333333333333 2.25],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Clear_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Clear',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'Limits';

h45 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Plot Limits',...
'Style','checkbox',...
'Value',1,...
'Position',[41.5 60.3333333333333 13.5 2],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Limits_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','Limits',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'BackgroundText';

h46 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','Background:',...
'Style','text',...
'Position',[165.5 60.1666666666667 11.8333333333333 2.25],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','BackgroundText');

appdata = [];
appdata.lastValidTag = 'Background';

h47 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String',{  'Zero (0)'; 'Estimate From Data before Transient'; 'Estimate From Data before and after Transient'; 'Estimate From valid data' },...
'Style','popupmenu',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[178 60.5833333333333 29 1.83333333333334],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Background_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Background_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','Background');

appdata = [];
appdata.lastValidTag = 'GridPanel';

h48 = uipanel(...
'Parent',h1,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','characters',...
'Title','Gird Management',...
'Tag','GridPanel',...
'Position',[183.166666666667 0.666666666666667 52.8333333333333 16.8333333333333],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'RunGrid';

h49 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Calculate Grid',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[2.33333333333333 12.8333333333333 14 2.25],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('RunGrid_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','RunGrid',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'PlotGrid';

h50 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Plot Grid',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[17.8333333333333 12.8333333333333 13.3333333333333 2.25],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('PlotGrid_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','PlotGrid',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'Grid';

h51 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String',{  'vect0    [53000         53000.1         53000.2         53000.3         53000.4         53000.5         53000.6         53000.7         53000.8         53000.9           53001         53001.1         53001.2         53001.3         53001.4         53001.5         53001.6         53001.7         53001.8         53001.9]'; 'vecRs    [200      218.18182      236.36364      254.54545      272.72727      290.90909      309.09091      327.27273      345.45455      363.63636      381.81818            400      418.18182      436.36364      454.54545      472.72727      490.90909      509.09091      527.27273      545.45455      563.63636      581.81818            600      618.18182      636.36364      654.54545      672.72727      690.90909      709.09091      727.27273      745.45455      763.63636      781.81818            800      818.18182      836.36364      854.54545      872.72727      890.90909      909.09091      927.27273      945.45455      963.63636      981.81818           1000      1018.1818      1036.3636      1054.5455      1072.7273      1090.9091      1109.0909      1127.2727      1145.4545      1163.6364      1181.8182           1200      1218.1818      1236.3636      1254.5455      1272.7273      1290.9091      1309.0909      1327.2727      1345.4545      1363.6364      1381.8182           1400      1418.1818      1436.3636      1454.5455      1472.7273      1490.9091      1509.0909      1527.2727      1545.4545      1563.6364      1581.8182           1600      1618.1818      1636.3636      1654.5455      1672.7273      1690.9091      1709.0909      1727.2727      1745.4545      1763.6364      1781.8182           1800      1818.1818      1836.3636      1854.5455      1872.7273      1890.9091      1909.0909      1927.2727      1945.4545      1963.6364      1981.8182           2000]'; 'vecVs    [0.5     0.50811     0.51636     0.52473     0.53325      0.5419     0.55069     0.55963     0.56871     0.57793     0.58731     0.59684     0.60652     0.61636     0.62636     0.63653     0.64685     0.65735     0.66801     0.67885     0.68986     0.70106     0.71243     0.72399     0.73574     0.74767     0.75981     0.77213     0.78466     0.79739     0.81033     0.82348     0.83684     0.85041     0.86421     0.87823     0.89248     0.90696     0.92168     0.93663     0.95183     0.96727     0.98296     0.99891      1.0151      1.0316      1.0483      1.0653      1.0826      1.1002       1.118      1.1362      1.1546      1.1733      1.1924      1.2117      1.2314      1.2514      1.2717      1.2923      1.3133      1.3346      1.3562      1.3782      1.4006      1.4233      1.4464      1.4699      1.4937       1.518      1.5426      1.5676       1.593      1.6189      1.6452      1.6719       1.699      1.7265      1.7546       1.783      1.8119      1.8413      1.8712      1.9016      1.9324      1.9638      1.9956       2.028      2.0609      2.0944      2.1283      2.1629       2.198      2.2336      2.2699      2.3067      2.3441      2.3822      2.4208      2.4601         2.5]'; 'vecMs    [2      3.05882      4.11765      5.17647      6.23529      7.29412      8.35294      9.41176      10.4706      11.5294      12.5882      13.6471      14.7059      15.7647      16.8235      17.8824      18.9412           20]'; 'vecFrho  [0.57735      0.7141     0.88324      1.0924      1.3512      1.6712      2.0671      2.5567      3.1623]'; 'vecEbv  [0.1        0.11        0.12        0.13        0.14        0.15        0.16        0.17        0.18        0.19         0.2]' },...
'Style','listbox',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[2.83333333333333 5.66666666666667 47 6.5],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Grid_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Grid_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','Grid',...
'UserData',struct(...
    't0', struct(...
    'method', 'lin', ...
    'min', 53000, ...
    'max', 53001.9, ...
    'steps', 20, ...
    'vec', [53000 53000.1 53000.2 53000.3 53000.4 53000.5 53000.6 53000.7 53000.8 53000.9 53001 53001.1 53001.2 53001.3 53001.4 53001.5 53001.6 53001.7 53001.8 53001.9]), ...
    'Rs', struct(...
    'method', 'lin', ...
    'min', 200, ...
    'max', 2000, ...
    'steps', 100, ...
    'vec', [200 218.181818181818 236.363636363636 254.545454545455 272.727272727273 290.909090909091 309.090909090909 327.272727272727 345.454545454545 363.636363636364 381.818181818182 400 418.181818181818 436.363636363636 454.545454545455 472.727272727273 490.909090909091 509.090909090909 527.272727272727 545.454545454545 563.636363636364 581.818181818182 600 618.181818181818 636.363636363636 654.545454545455 672.727272727273 690.909090909091 709.090909090909 727.272727272727 745.454545454545 763.636363636364 781.818181818182 800 818.181818181818 836.363636363636 854.545454545455 872.727272727273 890.909090909091 909.090909090909 927.272727272727 945.454545454545 963.636363636364 981.818181818182 1000 1018.18181818182 1036.36363636364 1054.54545454545 1072.72727272727 1090.90909090909 1109.09090909091 1127.27272727273 1145.45454545455 1163.63636363636 1181.81818181818 1200 1218.18181818182 1236.36363636364 1254.54545454545 1272.72727272727 1290.90909090909 1309.09090909091 1327.27272727273 1345.45454545455 1363.63636363636 1381.81818181818 1400 1418.18181818182 1436.36363636364 1454.54545454545 1472.72727272727 1490.90909090909 1509.09090909091 1527.27272727273 1545.45454545455 1563.63636363636 1581.81818181818 1600 1618.18181818182 1636.36363636364 1654.54545454545 1672.72727272727 1690.90909090909 1709.09090909091 1727.27272727273 1745.45454545455 1763.63636363636 1781.81818181818 1800 1818.18181818182 1836.36363636364 1854.54545454545 1872.72727272727 1890.90909090909 1909.09090909091 1927.27272727273 1945.45454545455 1963.63636363636 1981.81818181818 2000]), ...
    'Vs', struct(...
    'method', 'log', ...
    'min', 0.5, ...
    'max', 2.5, ...
    'steps', 101, ...
    'vec', [0.5 0.508112295633663 0.516356209948222 0.524733878402977 0.533247471104184 0.541899193367184 0.55069128628766 0.559626027322155 0.568705730878014 0.577932748912896 0.587309471544009 0.59683832766724 0.606521785586315 0.616362353652182 0.626362580912755 0.636525057773212 0.646852416666993 0.657347332737697 0.668012524532033 0.678850754704019 0.689864830730607 0.701057605638914 0.712431978745256 0.723990896406169 0.735737352781624 0.74767439061061 0.759805101999314 0.772132629222082 0.784660165535376 0.797390956004939 0.810328298346381 0.823475543779399 0.836836097895858 0.850413421541962 0.864211031714728 0.878232502473014 0.892481465863319 0.906961612860615 0.921676694324433 0.936630521970466 0.951826969357939 0.967269972892989 0.982963532848335 0.998911714399486 1.01511864867776 1.0315885338404 1.04832563615802 1.06533429111974 1.08261890455622 1.10018395378093 1.11803398874989 1.13617363324034 1.15460758604838 1.17334062220616 1.19237759421881 1.21172343332133 1.23138315075601 1.25136183907049 1.27166467343694 1.29229691299255 1.31326390220188 1.33457107224124 1.35622394240555 1.37822812153804 1.40058930948313 1.42331329856288 1.44640597507741 1.46987332082966 1.49372141467487 1.51795643409522 1.54258465680002 1.56761246235185 1.59304633381908 1.6188928594552 1.64515873440546 1.67185076244105 1.69897585772163 1.72654104658622 1.75455346937334 1.78302038227059 1.81194915919424 1.84134729369934 1.87122240092081 1.90158221954601 1.93243461381936 1.96378757557941 1.99564922632904 2.02802781933918 2.06093174178673 2.09436951692707 2.12834980630196 2.1628814119831 2.19797327885222 2.2336344969181 2.2698743036712 2.30670208647647 2.34412738500504 2.38215989370529 2.42080946431407 2.46008610840864 2.5]), ...
    'Ms', struct(...
    'method', 'lin', ...
    'min', 2, ...
    'max', 20, ...
    'steps', 18, ...
    'vec', [2 3.05882352941176 4.11764705882353 5.17647058823529 6.23529411764706 7.29411764705882 8.35294117647059 9.41176470588235 10.4705882352941 11.5294117647059 12.5882352941176 13.6470588235294 14.7058823529412 15.7647058823529 16.8235294117647 17.8823529411765 18.9411764705882 20]), ...
    'frho', struct(...
    'method', 'log', ...
    'min', 0.577350269189626, ...
    'max', 3.16227766016838, ...
    'steps', 9, ...
    'vec', [0.577350269189626 0.714100687283664 0.883241627815914 1.09244506691956 1.35120015480703 1.6712436292094 2.06709217597144 2.55670088387033 3.16227766016838]), ...
    'Ebv', struct(...
    'method', 'lin', ...
    'min', 0.1, ...
    'max', 0.2, ...
    'steps', 11, ...
    'vec', [0.1 0.11 0.12 0.13 0.14 0.15 0.16 0.17 0.18 0.19 0.2])));

appdata = [];
appdata.lastValidTag = 'SpanMethod';

h52 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String',{  'linspace'; 'logspace'; 'manual' },...
'Style','popupmenu',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[2.66666666666667 3.41666666666667 10 1.83333333333333],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('SpanMethod_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('SpanMethod_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','SpanMethod');

appdata = [];
appdata.lastValidTag = 'Min';

h53 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','200',...
'Style','edit',...
'Position',[14.1666666666667 3.66666666666667 8.66666666666667 1.5],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Min_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Min_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','Min');

appdata = [];
appdata.lastValidTag = 'Max';

h54 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','2000',...
'Style','edit',...
'Position',[24.3333333333333 3.58333333333333 8.66666666666667 1.5],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Max_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Max_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Max',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'Steps';

h55 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','100',...
'Style','edit',...
'Position',[34.5 3.58333333333333 7 1.5],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Steps_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Steps_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Steps',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'Populate';

h56 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Enter',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[42.8333333333333 3.5 6.66666666666666 1.75],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('Populate_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','Populate',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'MinText';

h57 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','min value',...
'Style','text',...
'Position',[14.3333333333333 2.58333333333333 8.66666666666667 1.25],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','MinText');

appdata = [];
appdata.lastValidTag = 'MaxText';

h58 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','max value',...
'Style','text',...
'Position',[24.3333333333333 2.5 8.83333333333333 1.25],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','MaxText');

appdata = [];
appdata.lastValidTag = 'StepsText';

h59 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','steps',...
'Style','text',...
'Position',[34.3333333333333 2.58333333333333 7.16666666666666 1.25],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','StepsText');

appdata = [];
appdata.lastValidTag = 'MinTPointsBand';

h60 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Band',...
'Style','popupmenu',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[21.6666666666667 0.0833333333333333 19.8333333333333 2.41666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('MinTPointsBand_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('MinTPointsBand_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','MinTPointsBand');

appdata = [];
appdata.lastValidTag = 'MinTPointsText';

h61 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','Min Transient Points:',...
'Style','text',...
'Position',[3.16666666666667 0.666666666666667 18.6666666666667 1.5],...
'Children',[],...
'Tag','MinTPointsText',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'MinTPoints';

h62 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','0',...
'Style','edit',...
'Position',[43.1666666666667 0.916666666666667 6.83333333333334 1.58333333333333],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('MinTPoints_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('MinTPoints_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','MinTPoints');

appdata = [];
appdata.lastValidTag = 'PeakNumText';

h63 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Peak #',...
'Style','text',...
'Position',[33.1666666666667 13.25 8.66666666666666 1.33333333333333],...
'Children',[],...
'Tag','PeakNumText',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'PeakNumber';

h64 = uicontrol(...
'Parent',h48,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','1',...
'Style','edit',...
'Position',[41.5 13 8.5 1.91666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('PeakNumber_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tooltip','The Number of the grid local maxima for which to plot the 1 sigma lines ',...
'TooltipString','The Number of the grid local maxima for which to plot the 1 sigma lines ',...
'TooltipStringMode',get(0,'defaultuicontrolTooltipStringMode'),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('PeakNumber_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','PeakNumber');

appdata = [];
appdata.lastValidTag = 'BackgroundValue';

h65 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','0',...
'Style','edit',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[208 60.3333333333333 12 2.16666666666666],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('BackgroundValue_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tooltip',blanks(0),...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable','off',...
'Visible',get(0,'defaultuicontrolVisible'),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','BackgroundValue',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'SNname';

h66 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'String','No SN loaded',...
'Style','text',...
'Position',[58 63.25 75.1666666666667 4.25],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','SNname',...
'FontSize',40,...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'RedShiftText';

h67 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','Red Shift:',...
'Style','text',...
'Position',[142.666666666667 64.25 12.1666666666667 1.83333333333333],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','RedShiftText');

appdata = [];
appdata.lastValidTag = 'RedShift';

h68 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','0.0732',...
'Style','edit',...
'Position',[155 64.3333333333333 12.6666666666667 2.16666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('RedShift_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('RedShift_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','RedShift');

appdata = [];
appdata.lastValidTag = 'RAtext';

h69 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','RA:',...
'Style','text',...
'Position',[172.166666666667 64.25 12 1.83333333333333],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','RAtext');

appdata = [];
appdata.lastValidTag = 'RA';

h70 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','00:00:00.00',...
'Style','edit',...
'Position',[180.166666666667 64.3333333333333 12.6666666666667 2.16666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('RA_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('RA_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','RA',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'dectext';

h71 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','dec:',...
'Style','text',...
'Position',[195.666666666667 64.25 12.1666666666667 1.83333333333333],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','dectext');

appdata = [];
appdata.lastValidTag = 'dec';

h72 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','+00:00:00.00',...
'Style','edit',...
'Position',[203.5 64.3333333333333 12.6666666666667 2.16666666666667],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('dec_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('dec_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','dec',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'BandNameText';

h73 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','left',...
'String','Band Name:',...
'Style','text',...
'Position',[99.8333333333333 59.0833333333333 10.6666666666667 1.41666666666666],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','BandNameText');

appdata = [];
appdata.lastValidTag = 'BandName';

h74 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','Name',...
'Style','edit',...
'Position',[112 59.0833333333333 21.3333333333333 1.83333333333334],...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('BandName_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('BandName_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','BandName');

appdata = [];
appdata.lastValidTag = 'MWEbv';

h75 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment','right',...
'String','MW Ebv  0.0000',...
'Style','text',...
'Position',[219.166666666667 63.6666666666667 14.1666666666667 2.24999999999999],...
'Children',[],...
'Tag','MWEbv',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'BG_sigma';

h76 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','0',...
'Style','edit',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[223 60.3333333333333 12.3 2.16666666666666],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('BG_sigma_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tooltip',blanks(0),...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable','off',...
'Visible',get(0,'defaultuicontrolVisible'),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('BG_sigma_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','BG_sfigma',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'BG_plus_minus_text';

h77 = uicontrol(...
'Parent',h1,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'String','±',...
'Style','text',...
'Position',[221.5 60.6666666666667 1.33333333333334 1.33333333333334],...
'Children',[],...
'Tag','BG_plus_minus_text',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'PhotoFitPanel';

% h2 = uipanel(...
% 'Parent',h1,...
% 'FontUnits',get(0,'defaultuipanelFontUnits'),...
% 'Units','characters',...
% 'Title',blanks(0),...
% 'Tag','FilePanel',...
% 'Position',[8.16666666666667 0.666666666666676 83.5 7.58333333333333],...
% 'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

h78 = uipanel(...
'Parent',h1,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','characters',...
'Title','Black Body radius and temperature',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','PhotoFitPanel',...
'Position',[99.8333333333333 0.75 78.6666666666667 4.25],...
'FontName',get(0,'defaultuipanelFontName'));%,...
%'Tooltip',blanks(0),...
%'ForegroundColor',get(0,'defaultuipanelForegroundColor'),...
%'HighlightColor',get(0,'defaultuipanelHighlightColor'),...
%'ShadowColor',get(0,'defaultuipanelShadowColor'),...
%'BorderType',get(0,'defaultuipanelBorderType'),...
%'BorderWidth',get(0,'defaultuipanelBorderWidth'),...
%'TitlePosition',get(0,'defaultuipanelTitlePosition'),...
%'Visible',get(0,'defaultuipanelVisible'),...
%'BackgroundColor',get(0,'defaultuipanelBackgroundColor'),...
%'ResizeFcn',blanks(0),...
%'HandleVisibility',get(0,'defaultuipanelHandleVisibility'),...
%'ButtonDownFcn',blanks(0),...
%'DeleteFcn',blanks(0),...
%'UserData',[],...
%'FontSize',get(0,'defaultuipanelFontSize'),...
%'FontAngle',get(0,'defaultuipanelFontAngle'),...
%'FontWeight',get(0,'defaultuipanelFontWeight'));

appdata = [];
appdata.lastValidTag = 'PhotoFit';

h79 = uicontrol(...
'Parent',h78,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Estimate',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[1.83333333333333 0.75 16.5 1.91666666666667],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('PhotoFit_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tooltip',blanks(0),...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'Visible',get(0,'defaultuicontrolVisible'),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','PhotoFit',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'PlotPhotoFit';

h80 = uicontrol(...
'Parent',h78,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Plot vs. Model',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[20.8333333333333 0.75 16.5 1.91666666666667],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('PlotPhotoFit_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tooltip',blanks(0),...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'Visible',get(0,'defaultuicontrolVisible'),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','PlotPhotoFit',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'GridRbbFilter';

h81 = uicontrol(...
'Parent',h78,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Generate Grid Filter',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[39.8333333333333 0.75 16.5 1.91666666666667],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('GridRbbFilter_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tooltip',blanks(0),...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'Visible',get(0,'defaultuicontrolVisible'),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','GridRbbFilter',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'FilterGrid';

h82 = uicontrol(...
'Parent',h78,...
'Units','characters',...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Filter Grid',...
'Style','checkbox',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[62.1666666666667 1 11.6666666666667 1.41666666666667],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)AstroUtil.supernova.SOPRANOS.SOPRANOS_GUI('FilterGrid_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tooltip',blanks(0),...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'Visible',get(0,'defaultuicontrolVisible'),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','FilterGrid',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));


hsingleton = h1;


% --- Set application data first then calling the CreateFcn. 
function local_CreateFcn(hObject, eventdata, createfcn, appdata)

if ~isempty(appdata)
   names = fieldnames(appdata);
   for i=1:length(names)
       name = char(names(i));
       setappdata(hObject, name, getfield(appdata,name));
   end
end

if ~isempty(createfcn)
   if isa(createfcn,'function_handle')
       createfcn(hObject, eventdata);
   else
       eval(createfcn);
   end
end


% --- Handles default GUIDE GUI creation and callback dispatch
function varargout = gui_mainfcn(gui_State, varargin)

gui_StateFields =  {'gui_Name'
    'gui_Singleton'
    'gui_OpeningFcn'
    'gui_OutputFcn'
    'gui_LayoutFcn'
    'gui_Callback'};
gui_Mfile = '';
for i=1:length(gui_StateFields)
    if ~isfield(gui_State, gui_StateFields{i})
        error(message('MATLAB:guide:StateFieldNotFound', gui_StateFields{ i }, gui_Mfile));
    elseif isequal(gui_StateFields{i}, 'gui_Name')
        gui_Mfile = [gui_State.(gui_StateFields{i}), '.m'];
    end
end

numargin = length(varargin);

if numargin == 0
    % SOPRANOS_GUI
    % create the GUI only if we are not in the process of loading it
    % already
    gui_Create = true;
elseif local_isInvokeActiveXCallback(gui_State, varargin{:})
    % SOPRANOS_GUI(ACTIVEX,...)
    vin{1} = gui_State.gui_Name;
    vin{2} = [get(varargin{1}.Peer, 'Tag'), '_', varargin{end}];
    vin{3} = varargin{1};
    vin{4} = varargin{end-1};
    vin{5} = guidata(varargin{1}.Peer);
    feval(vin{:});
    return;
elseif local_isInvokeHGCallback(gui_State, varargin{:})
    % SOPRANOS_GUI('CALLBACK',hObject,eventData,handles,...)
    gui_Create = false;
else
    % SOPRANOS_GUI(...)
    % create the GUI and hand varargin to the openingfcn
    gui_Create = true;
end

if ~gui_Create
    % In design time, we need to mark all components possibly created in
    % the coming callback evaluation as non-serializable. This way, they
    % will not be brought into GUIDE and not be saved in the figure file
    % when running/saving the GUI from GUIDE.
    designEval = false;
    if (numargin>1 && ishghandle(varargin{2}))
        fig = varargin{2};
        while ~isempty(fig) && ~ishghandle(fig,'figure')
            fig = get(fig,'parent');
        end
        
        designEval = isappdata(0,'CreatingGUIDEFigure') || (isscalar(fig)&&isprop(fig,'GUIDEFigure'));
    end
        
    if designEval
        beforeChildren = findall(fig);
    end
    
    % evaluate the callback now
    varargin{1} = gui_State.gui_Callback;
    if nargout
        [varargout{1:nargout}] = feval(varargin{:});
    else       
        feval(varargin{:});
    end
    
    % Set serializable of objects created in the above callback to off in
    % design time. Need to check whether figure handle is still valid in
    % case the figure is deleted during the callback dispatching.
    if designEval && ishghandle(fig)
        set(setdiff(findall(fig),beforeChildren), 'Serializable','off');
    end
else
    if gui_State.gui_Singleton
        gui_SingletonOpt = 'reuse';
    else
        gui_SingletonOpt = 'new';
    end

    % Check user passing 'visible' P/V pair first so that its value can be
    % used by oepnfig to prevent flickering
    gui_Visible = 'auto';
    gui_VisibleInput = '';
    for index=1:2:length(varargin)
        if length(varargin) == index || ~ischar(varargin{index})
            break;
        end

        % Recognize 'visible' P/V pair
        len1 = min(length('visible'),length(varargin{index}));
        len2 = min(length('off'),length(varargin{index+1}));
        if ischar(varargin{index+1}) && strncmpi(varargin{index},'visible',len1) && len2 > 1
            if strncmpi(varargin{index+1},'off',len2)
                gui_Visible = 'invisible';
                gui_VisibleInput = 'off';
            elseif strncmpi(varargin{index+1},'on',len2)
                gui_Visible = 'visible';
                gui_VisibleInput = 'on';
            end
        end
    end
    
    % Open fig file with stored settings.  Note: This executes all component
    % specific CreateFunctions with an empty HANDLES structure.

    
    % Do feval on layout code in m-file if it exists
    gui_GUIed = ~isempty(gui_State.gui_LayoutFcn);
    % this application data is used to indicate the running mode of a GUIDE
    % GUI to distinguish it from the design mode of the GUI in GUIDE. it is
    % only used by actxproxy at this time.   
    setappdata(0,genvarname(['OpenGuiWhenRunning_', gui_State.gui_Name]),1);
    if gui_GUIed
        gui_hFigure = feval(gui_State.gui_LayoutFcn, gui_SingletonOpt);

        % make figure invisible here so that the visibility of figure is
        % consistent in OpeningFcn in the exported GUI case
        if isempty(gui_VisibleInput)
            gui_VisibleInput = get(gui_hFigure,'Visible');
        end
        set(gui_hFigure,'Visible','off')

        % openfig (called by local_openfig below) does this for guis without
        % the LayoutFcn. Be sure to do it here so guis show up on screen.
        movegui(gui_hFigure,'onscreen');
    else
        gui_hFigure = local_openfig(gui_State.gui_Name, gui_SingletonOpt, gui_Visible);
        % If the figure has InGUIInitialization it was not completely created
        % on the last pass.  Delete this handle and try again.
        if isappdata(gui_hFigure, 'InGUIInitialization')
            delete(gui_hFigure);
            gui_hFigure = local_openfig(gui_State.gui_Name, gui_SingletonOpt, gui_Visible);
        end
    end
    if isappdata(0, genvarname(['OpenGuiWhenRunning_', gui_State.gui_Name]))
        rmappdata(0,genvarname(['OpenGuiWhenRunning_', gui_State.gui_Name]));
    end

    % Set flag to indicate starting GUI initialization
    setappdata(gui_hFigure,'InGUIInitialization',1);

    % Fetch GUIDE Application options
    gui_Options = getappdata(gui_hFigure,'GUIDEOptions');
    % Singleton setting in the GUI MATLAB code file takes priority if different
    gui_Options.singleton = gui_State.gui_Singleton;

    if ~isappdata(gui_hFigure,'GUIOnScreen')
        % Adjust background color
        if gui_Options.syscolorfig
            set(gui_hFigure,'Color', get(0,'DefaultUicontrolBackgroundColor'));
        end

        % Generate HANDLES structure and store with GUIDATA. If there is
        % user set GUI data already, keep that also.
        data = guidata(gui_hFigure);
        handles = guihandles(gui_hFigure);
        if ~isempty(handles)
            if isempty(data)
                data = handles;
            else
                names = fieldnames(handles);
                for k=1:length(names)
                    data.(char(names(k)))=handles.(char(names(k)));
                end
            end
        end
        guidata(gui_hFigure, data);
    end

    % Apply input P/V pairs other than 'visible'
    for index=1:2:length(varargin)
        if length(varargin) == index || ~ischar(varargin{index})
            break;
        end

        len1 = min(length('visible'),length(varargin{index}));
        if ~strncmpi(varargin{index},'visible',len1)
            try set(gui_hFigure, varargin{index}, varargin{index+1}), catch break, end
        end
    end

    % If handle visibility is set to 'callback', turn it on until finished
    % with OpeningFcn
    gui_HandleVisibility = get(gui_hFigure,'HandleVisibility');
    if strcmp(gui_HandleVisibility, 'callback')
        set(gui_hFigure,'HandleVisibility', 'on');
    end

    feval(gui_State.gui_OpeningFcn, gui_hFigure, [], guidata(gui_hFigure), varargin{:});

    if isscalar(gui_hFigure) && ishghandle(gui_hFigure)
        % Handle the default callbacks of predefined toolbar tools in this
        % GUI, if any
        guidemfile('restoreToolbarToolPredefinedCallback',gui_hFigure); 
        
        % Update handle visibility
        set(gui_hFigure,'HandleVisibility', gui_HandleVisibility);

        % Call openfig again to pick up the saved visibility or apply the
        % one passed in from the P/V pairs
        if ~gui_GUIed
            gui_hFigure = local_openfig(gui_State.gui_Name, 'reuse',gui_Visible);
        elseif ~isempty(gui_VisibleInput)
            set(gui_hFigure,'Visible',gui_VisibleInput);
        end
        if strcmpi(get(gui_hFigure, 'Visible'), 'on')
            figure(gui_hFigure);
            
            if gui_Options.singleton
                setappdata(gui_hFigure,'GUIOnScreen', 1);
            end
        end

        % Done with GUI initialization
        if isappdata(gui_hFigure,'InGUIInitialization')
            rmappdata(gui_hFigure,'InGUIInitialization');
        end

        % If handle visibility is set to 'callback', turn it on until
        % finished with OutputFcn
        gui_HandleVisibility = get(gui_hFigure,'HandleVisibility');
        if strcmp(gui_HandleVisibility, 'callback')
            set(gui_hFigure,'HandleVisibility', 'on');
        end
        gui_Handles = guidata(gui_hFigure);
    else
        gui_Handles = [];
    end

    if nargout
        [varargout{1:nargout}] = feval(gui_State.gui_OutputFcn, gui_hFigure, [], gui_Handles);
    else
        feval(gui_State.gui_OutputFcn, gui_hFigure, [], gui_Handles);
    end

    if isscalar(gui_hFigure) && ishghandle(gui_hFigure)
        set(gui_hFigure,'HandleVisibility', gui_HandleVisibility);
    end
end

function gui_hFigure = local_openfig(name, singleton, visible)

% openfig with three arguments was new from R13. Try to call that first, if
% failed, try the old openfig.
if nargin('openfig') == 2
    % OPENFIG did not accept 3rd input argument until R13,
    % toggle default figure visible to prevent the figure
    % from showing up too soon.
    gui_OldDefaultVisible = get(0,'defaultFigureVisible');
    set(0,'defaultFigureVisible','off');
    gui_hFigure = matlab.hg.internal.openfigLegacy(name, singleton);
    set(0,'defaultFigureVisible',gui_OldDefaultVisible);
else
    % Call version of openfig that accepts 'auto' option"
    gui_hFigure = matlab.hg.internal.openfigLegacy(name, singleton, visible);  
%     %workaround for CreateFcn not called to create ActiveX
%         peers=findobj(findall(allchild(gui_hFigure)),'type','uicontrol','style','text');    
%         for i=1:length(peers)
%             if isappdata(peers(i),'Control')
%                 actxproxy(peers(i));
%             end            
%         end
end

function result = local_isInvokeActiveXCallback(gui_State, varargin)

try
    result = ispc && iscom(varargin{1}) ...
             && isequal(varargin{1},gcbo);
catch
    result = false;
end

function result = local_isInvokeHGCallback(gui_State, varargin)

try
    fhandle = functions(gui_State.gui_Callback);
    result = ~isempty(findstr(gui_State.gui_Name,fhandle.file)) || ...
             (ischar(varargin{1}) ...
             && isequal(ishghandle(varargin{2}), 1) ...
             && (~isempty(strfind(varargin{1},[get(varargin{2}, 'Tag'), '_'])) || ...
                ~isempty(strfind(varargin{1}, '_CreateFcn'))) );
catch
    result = false;
end


