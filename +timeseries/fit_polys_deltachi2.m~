function Res=fit_polys_deltachi2(Data,varargin)
% SHORT DESCRIPTION HERE
% Package: timeseries
% Description: 
% Input  : - 
%          * Arbitrary number of pairs of arguments: ...,keyword,value,...
%            where keyword are one of the followings:
% Output : - 
% License: GNU general public license version 3
%     By : Eran O. Ofek                    Aug 2019
%    URL : http://weizmann.ac.il/home/eofek/matlab/
% Example: Data=timeseries.fit_polys_deltachi2(Cat)
% Reliable: 
%--------------------------------------------------------------------------


DefV.RejectProb           = 0.95;
DefV.MaxOrder             = 10;
DefV.ColT                 = 1;
DefV.ColM                 = 2;
DefV.ColE                 = 3;
InPar = InArg.populate_keyval(DefV,varargin,mfilename);


T = Data(:,InPar.ColT);
M = Data(:,InPar.ColM);
E = Data(:,InPar.ColE);

MeanT  = mean(T);
RangeT = range(T);

T = (T-MeanT)./RangeT;

Npt = numel(T);
InPar.MaxOrder = min(Npt-1,InPar.MaxOrder);

VecOrder = (0:1:InPar.MaxOrder);
Norders  = numel(VecOrder);
Npar     = VecOrder + 1;


Mpred = zeros(Npt,Norders);
for I=1:1:Norders
    Deg   = VecOrder(I);
    
    Par   = polyfit(T,M,Deg);
    Mpred(:,I) = polyval(Par,T);
end

Resid = M - Mpred;
Res.Std   = std(Resid,[],1);
Chi2  = sum((Resid./E).^2,1);

Res.Chi2 = Chi2;

Chi2Factor = (Res.Chi2./(Npt-Npar));

Res.NewChi2 = Chi2./Chi2Factor
Res.Dechi2inv(InPar.RejectProb,Npar)

NewChi2(2:end) - (NewChi2(1:end-1) - chi2inv(InPar.RejectProb,Npar(1:end-1)))
